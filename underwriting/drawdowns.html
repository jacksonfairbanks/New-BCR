<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC Drawdowns & Path Dependency | Underwriting Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="../js/btc-data.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --border-color: #2a2a3a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --text-muted: #606070;
            --accent-orange: #f7931a;
            --accent-red: #ff4757;
            --accent-green: #00d4aa;
            --accent-blue: #4a9eff;
            --accent-purple: #a855f7;
            --accent-yellow: #ffd700;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .bg-pattern {
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(ellipse at 20% 30%, rgba(255, 71, 87, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 70%, rgba(168, 85, 247, 0.05) 0%, transparent 40%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            position: relative;
            z-index: 1;
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
        }
        
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, rgba(255, 71, 87, 0.3), rgba(255, 71, 87, 0.1));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 1px solid rgba(255, 71, 87, 0.3);
        }
        
        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .subtitle {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        
        .home-btn {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .home-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-orange);
            color: var(--accent-orange);
        }
        
        /* Main chart card */
        .main-chart-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .chart-hint {
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        
        .chart-hint span {
            color: var(--accent-red);
        }
        
        #main-chart {
            height: 450px;
            width: 100%;
        }
        
        /* Clickable zone overlays */
        .chart-wrapper {
            position: relative;
        }
        
        .zone-overlay {
            position: absolute;
            top: 30px;
            bottom: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
            border-radius: 4px;
        }
        
        .zone-overlay::before {
            content: 'Click for insights';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        .zone-overlay:hover::before {
            opacity: 1;
        }
        
        .zone-overlay:hover {
            animation: zonePulse 1.5s ease-in-out infinite;
        }
        
        .zone-2014 {
            background: rgba(255, 71, 87, 0.05);
            border: 2px solid transparent;
        }
        .zone-2014:hover {
            background: rgba(255, 71, 87, 0.25);
            border-color: rgba(255, 71, 87, 0.6);
            box-shadow: 0 0 30px rgba(255, 71, 87, 0.4), inset 0 0 30px rgba(255, 71, 87, 0.1);
        }
        .zone-2014::before { color: #ff4757; }
        
        .zone-2018 {
            background: rgba(168, 85, 247, 0.05);
            border: 2px solid transparent;
        }
        .zone-2018:hover {
            background: rgba(168, 85, 247, 0.25);
            border-color: rgba(168, 85, 247, 0.6);
            box-shadow: 0 0 30px rgba(168, 85, 247, 0.4), inset 0 0 30px rgba(168, 85, 247, 0.1);
        }
        .zone-2018::before { color: #a855f7; }
        
        .zone-2022 {
            background: rgba(74, 158, 255, 0.05);
            border: 2px solid transparent;
        }
        .zone-2022:hover {
            background: rgba(74, 158, 255, 0.25);
            border-color: rgba(74, 158, 255, 0.6);
            box-shadow: 0 0 30px rgba(74, 158, 255, 0.4), inset 0 0 30px rgba(74, 158, 255, 0.1);
        }
        .zone-2022::before { color: #4a9eff; }
        
        @keyframes zonePulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        
        /* ========== STRESS TEST SECTION ========== */
        .stress-test-controls {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px 25px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 40px;
            flex-wrap: wrap;
        }
        
        /* Inline stress test (below zoomed chart) */
        .stress-test-inline {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        .stress-test-inline-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--accent-orange);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stress-inline-grid {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 20px;
            align-items: center;
        }
        
        @media (max-width: 800px) {
            .stress-inline-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
        
        .implied-bcr-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 20px;
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.15) 0%, rgba(249, 115, 22, 0.05) 100%);
            border: 1px solid rgba(249, 115, 22, 0.3);
            border-radius: 10px;
            min-width: 100px;
        }
        
        .implied-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .implied-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent-orange);
        }
        
        .stress-test-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent-orange);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stress-test-title::before {
            content: 'üéØ';
        }
        
        .stress-control-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .stress-control-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .stress-control-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent-orange);
            min-width: 60px;
        }
        
        .stress-slider {
            width: 180px;
            height: 6px;
            -webkit-appearance: none;
            background: var(--bg-tertiary);
            border-radius: 3px;
            outline: none;
        }
        
        .stress-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent-orange);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(247, 147, 26, 0.4);
        }
        
        .stress-divider {
            width: 1px;
            height: 40px;
            background: var(--border-color);
        }
        
        .implied-params {
            display: flex;
            gap: 20px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        .implied-params span {
            color: var(--text-secondary);
        }
        
        /* Stress Test Results Panel */
        .stress-results-card {
            background: linear-gradient(135deg, rgba(247, 147, 26, 0.1) 0%, rgba(247, 147, 26, 0.02) 100%);
            border: 1px solid rgba(247, 147, 26, 0.3);
            border-radius: 16px;
            padding: 25px;
            margin-top: 25px;
        }
        
        .stress-results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .stress-results-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent-orange);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .survival-badge {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .survival-badge.survived {
            background: rgba(0, 212, 170, 0.2);
            color: var(--accent-green);
            border: 1px solid rgba(0, 212, 170, 0.4);
        }
        
        .survival-badge.failed {
            background: rgba(255, 71, 87, 0.2);
            color: var(--accent-red);
            border: 1px solid rgba(255, 71, 87, 0.4);
        }
        
        .stress-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stress-stat {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .stress-stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        
        .stress-stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.3rem;
            font-weight: 700;
        }
        
        .stress-stat-value.green { color: var(--accent-green); }
        .stress-stat-value.red { color: var(--accent-red); }
        .stress-stat-value.orange { color: var(--accent-orange); }
        .stress-stat-value.blue { color: var(--accent-blue); }
        
        /* Histogram Section */
        .histogram-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
        }
        
        .histogram-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .histogram-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .percentile-badge {
            background: linear-gradient(135deg, var(--accent-orange), #e8850f);
            color: #000;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        #stress-histogram {
            height: 200px;
        }
        
        .percentile-context {
            margin-top: 15px;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            border-left: 4px solid var(--accent-orange);
            font-size: 0.85rem;
            line-height: 1.6;
            color: var(--text-secondary);
        }
        
        .percentile-context strong {
            color: var(--accent-orange);
        }
        
        .percentile-context .highlight {
            color: var(--accent-green);
            font-weight: 600;
        }
        
        .percentile-context.mini {
            margin-top: 10px;
            padding: 10px;
            font-size: 0.75rem;
        }
        
        .dual-histogram-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 1000px) {
            .dual-histogram-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .comparison-insight {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(74, 158, 255, 0.1) 100%);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .comparison-insight-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--accent-purple);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .comparison-insight-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        /* Model Comparison Styles */
        .model-comparison-header {
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .model-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .model-label.bootstrap { color: #a855f7; }
        .model-label.jump { color: #f97316; }
        
        .model-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .regime-tag {
            font-size: 0.7rem;
            font-weight: 400;
            color: var(--text-muted);
            background: rgba(255,255,255,0.05);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .model-section {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .bootstrap-section {
            border-left: 3px solid #a855f7;
        }
        
        .jump-section {
            border-left: 3px solid #f97316;
        }
        
        .model-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .bootstrap-section .model-section-title { color: #a855f7; }
        .jump-section .model-section-title { color: #f97316; }
        
        .model-icon {
            font-size: 1rem;
        }
        
        .model-info {
            font-size: 0.7rem;
            font-weight: 400;
            color: var(--text-muted);
            margin-left: auto;
        }
        
        .model-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }
        
        .model-summary-card {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
        }
        
        .model-summary-card.bootstrap {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.15) 0%, rgba(168, 85, 247, 0.05) 100%);
            border: 1px solid rgba(168, 85, 247, 0.3);
        }
        
        .model-summary-card.jump {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.15) 0%, rgba(249, 115, 22, 0.05) 100%);
            border: 1px solid rgba(249, 115, 22, 0.3);
        }
        
        .model-summary-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }
        
        .model-summary-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .model-summary-card.bootstrap .model-summary-value { color: #a855f7; }
        .model-summary-card.jump .model-summary-value { color: #f97316; }
        
        .model-summary-subtext {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 3px;
        }
        
        /* Regime Comparison Grid */
        .regime-comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        @media (max-width: 900px) {
            .regime-comparison-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .regime-section {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        
        .current-regime {
            border-left: 3px solid #a855f7;
        }
        
        .bear-regime {
            border-left: 3px solid #ef4444;
        }
        
        .regime-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .regime-icon {
            font-size: 1.1rem;
        }
        
        .regime-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .current-regime .regime-name { color: #a855f7; }
        .bear-regime .regime-name { color: #ef4444; }
        
        .regime-dates {
            font-size: 0.7rem;
            color: var(--text-muted);
            background: rgba(255,255,255,0.05);
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: auto;
        }
        
        .regime-models {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .mini-model {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 10px;
        }
        
        .mini-model-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .mini-model-header .percentile-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
        }
        
        .regime-summary {
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .regime-avg-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .regime-avg-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        .current-regime .regime-avg-value { color: #a855f7; }
        .bear-regime .regime-avg-value { color: #ef4444; }
        .full-regime .regime-avg-value { color: #fbbf24; }
        
        .regime-comparison-grid.three-col {
            grid-template-columns: repeat(3, 1fr);
        }
        
        @media (max-width: 1000px) {
            .regime-comparison-grid.three-col {
                grid-template-columns: 1fr;
            }
        }
        
        .full-regime {
            border-left: 3px solid #fbbf24;
        }
        
        .full-regime .regime-name { color: #fbbf24; }
        
        .regime-models.stacked {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        /* Best Fit Card */
        .best-fit-card {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.02) 100%);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .best-fit-header {
            font-size: 0.85rem;
            font-weight: 600;
            color: #22c55e;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .best-fit-content {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        .best-fit-content strong {
            color: #22c55e;
        }
        
        .best-fit-content .regime-winner {
            display: inline-block;
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        /* Historical Rarity Card */
        .historical-rarity-card {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.08) 0%, rgba(251, 191, 36, 0.02) 100%);
            border: 1px solid rgba(251, 191, 36, 0.25);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .rarity-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(251, 191, 36, 0.2);
        }
        
        .rarity-icon {
            font-size: 1.2rem;
        }
        
        .rarity-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: #fbbf24;
        }
        
        .rarity-content {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 15px;
        }
        
        @media (max-width: 700px) {
            .rarity-content {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
        
        .rarity-stat {
            text-align: center;
        }
        
        .rarity-stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        
        .rarity-stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: #fbbf24;
        }
        
        .rarity-stat-sublabel {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 4px;
        }
        
        .rarity-validation {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 12px 15px;
            font-size: 0.8rem;
            line-height: 1.5;
            color: var(--text-secondary);
        }
        
        .rarity-validation strong {
            color: #fbbf24;
        }
        
        .rarity-validation .match {
            color: #22c55e;
            font-weight: 600;
        }
        
        .rarity-validation .mismatch {
            color: #ef4444;
            font-weight: 600;
        }
        
        /* Drawdown selector cards */
        .drawdown-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .dd-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
        }
        
        .dd-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--card-color);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .dd-card:hover {
            transform: translateY(-4px);
            border-color: var(--card-color);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3), 0 0 30px color-mix(in srgb, var(--card-color) 20%, transparent);
        }
        
        .dd-card:hover::before, .dd-card.active::before {
            opacity: 1;
        }
        
        .dd-card.active {
            border-color: var(--card-color);
            background: color-mix(in srgb, var(--card-color) 5%, var(--bg-secondary));
        }
        
        .dd-card.dd-2014 { --card-color: #ff4757; }
        .dd-card.dd-2018 { --card-color: #a855f7; }
        .dd-card.dd-2022 { --card-color: #4a9eff; }
        
        .dd-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .dd-year {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--card-color);
        }
        
        .dd-severity {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: color-mix(in srgb, var(--card-color) 15%, transparent);
            color: var(--card-color);
            border: 1px solid color-mix(in srgb, var(--card-color) 30%, transparent);
        }
        
        .dd-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .dd-quick-stats {
            display: flex;
            gap: 20px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }
        
        .dd-stat {
            flex: 1;
        }
        
        .dd-stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
        }
        
        .dd-stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .dd-stat-value.red { color: var(--accent-red); }
        .dd-stat-value.orange { color: var(--accent-orange); }
        
        /* Detail panel */
        .detail-panel {
            display: none;
            animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .detail-panel.active {
            display: block;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .detail-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
        }
        
        .detail-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .detail-title h2 {
            font-size: 1.6rem;
            font-weight: 700;
        }
        
        .detail-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            background: rgba(255, 71, 87, 0.15);
            color: var(--accent-red);
            border: 1px solid rgba(255, 71, 87, 0.3);
        }
        
        .close-detail {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .close-detail:hover {
            background: var(--accent-red);
            border-color: var(--accent-red);
            color: white;
        }
        
        /* Stats grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 18px;
        }
        
        .stat-card.highlight {
            background: linear-gradient(135deg, rgba(255, 71, 87, 0.1), rgba(255, 71, 87, 0.02));
            border-color: rgba(255, 71, 87, 0.3);
        }
        
        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .stat-value.red { color: var(--accent-red); }
        .stat-value.green { color: var(--accent-green); }
        .stat-value.orange { color: var(--accent-orange); }
        .stat-value.blue { color: var(--accent-blue); }
        .stat-value.purple { color: var(--accent-purple); }
        
        /* Detail grid */
        .detail-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
        }
        
        .chart-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
        }
        
        .chart-card-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-card-title .icon {
            font-size: 1.1rem;
        }
        
        #zoom-chart {
            height: 350px;
        }
        
        /* Narrative section */
        .narrative-section {
            margin-bottom: 20px;
        }
        
        .narrative-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--accent-orange);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .narrative-title.collapsible-header {
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
            padding: 8px 12px;
            margin: -8px -12px 10px -12px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .narrative-title.collapsible-header:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.15);
        }
        
        .expand-hint {
            margin-left: auto;
            font-size: 0.65rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            background: rgba(255, 255, 255, 0.08);
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .collapse-chevron {
            font-size: 0.9rem;
            transition: transform 0.3s ease;
            color: var(--text-muted);
            margin-left: 6px;
        }
        
        .collapse-chevron.expanded {
            transform: rotate(90deg);
        }
        
        .collapsible-content {
            overflow: hidden;
            max-height: 500px;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }
        
        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
        }
        
        .narrative-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.7;
        }
        
        .narrative-text strong {
            color: var(--text-primary);
        }
        
        /* Timeline */
        .timeline {
            position: relative;
            padding-left: 25px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 5px;
            bottom: 5px;
            width: 2px;
            background: var(--border-color);
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -21px;
            top: 6px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-red);
            border: 2px solid var(--bg-secondary);
        }
        
        .timeline-item.recovery::before {
            background: var(--accent-green);
        }
        
        .timeline-date {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 4px;
        }
        
        .timeline-event {
            font-size: 0.9rem;
            color: var(--text-primary);
        }
        
        /* Clustering stats */
        .clustering-section {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 18px;
            margin-top: 20px;
        }
        
        .clustering-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--accent-purple);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .clustering-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .clustering-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            position: relative;
        }
        
        .clustering-label {
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .clustering-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }
        
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            color: var(--text-muted);
            font-size: 10px;
            font-weight: 600;
            cursor: help;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .info-icon:hover {
            background: var(--accent-orange);
            color: var(--bg-primary);
        }
        
        .metric-tooltip {
            position: absolute;
            left: 0;
            bottom: calc(100% + 8px);
            width: 280px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(5px);
            transition: all 0.2s ease;
            pointer-events: none;
        }
        
        .info-icon:hover + .metric-tooltip,
        .metric-tooltip:hover {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            pointer-events: auto;
        }
        
        .metric-tooltip::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 20px;
            width: 10px;
            height: 10px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            transform: rotate(45deg);
        }
        
        .tooltip-title {
            font-weight: 600;
            color: var(--accent-orange);
            margin-bottom: 6px;
            font-size: 0.85rem;
        }
        
        .tooltip-desc {
            color: var(--text-secondary);
            font-size: 0.8rem;
            line-height: 1.5;
            margin-bottom: 8px;
        }
        
        .tooltip-why {
            font-size: 0.75rem;
            color: var(--text-muted);
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
            font-style: italic;
        }
        
        .tooltip-why strong {
            color: var(--accent-green);
            font-style: normal;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
            .detail-grid { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 768px) {
            .drawdown-selector { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">üìâ</div>
                <div>
                    <h1>Drawdowns & Path Dependency</h1>
                    <p class="subtitle">Interactive analysis of Bitcoin's most severe declines</p>
                </div>
            </div>
            <a href="../index.html" class="home-btn">‚Üê Dashboard</a>
        </header>

        <!-- Main BTC Chart -->
        <div class="main-chart-card">
            <div class="chart-header">
                <div class="chart-title">Bitcoin Price History (2014‚Äì2025)</div>
                <div class="chart-hint">Click on <span>highlighted regions</span> to explore each drawdown</div>
            </div>
            <div class="chart-wrapper">
                <div id="main-chart"></div>
                <!-- Clickable zone overlays - positioned by JS -->
                <div class="zone-overlay zone-2014" data-year="2014" onclick="selectDrawdown('2014')"></div>
                <div class="zone-overlay zone-2018" data-year="2018" onclick="selectDrawdown('2018')"></div>
                <div class="zone-overlay zone-2022" data-year="2022" onclick="selectDrawdown('2022')"></div>
            </div>
        </div>

        <!-- Drawdown Selector Cards -->
        <div class="drawdown-selector">
            <div class="dd-card dd-2014" onclick="selectDrawdown('2014')">
                <div class="dd-card-header">
                    <div class="dd-year">2014</div>
                    <div class="dd-severity">Catastrophic</div>
                </div>
                <div class="dd-name">Mt. Gox Collapse</div>
                <div class="dd-quick-stats">
                    <div class="dd-stat">
                        <div class="dd-stat-label">Max Drawdown</div>
                        <div class="dd-stat-value red">-86%</div>
                    </div>
                    <div class="dd-stat">
                        <div class="dd-stat-label">Duration</div>
                        <div class="dd-stat-value orange">411 days</div>
                    </div>
                </div>
            </div>

            <div class="dd-card dd-2018" onclick="selectDrawdown('2018')">
                <div class="dd-card-header">
                    <div class="dd-year">2018</div>
                    <div class="dd-severity">Catastrophic</div>
                </div>
                <div class="dd-name">ICO Bubble Burst</div>
                <div class="dd-quick-stats">
                    <div class="dd-stat">
                        <div class="dd-stat-label">Max Drawdown</div>
                        <div class="dd-stat-value red">-84%</div>
                    </div>
                    <div class="dd-stat">
                        <div class="dd-stat-label">Duration</div>
                        <div class="dd-stat-value orange">364 days</div>
                    </div>
                </div>
            </div>

            <div class="dd-card dd-2022" onclick="selectDrawdown('2022')">
                <div class="dd-card-header">
                    <div class="dd-year">2022</div>
                    <div class="dd-severity">Severe</div>
                </div>
                <div class="dd-name">Fed Tightening & Contagion</div>
                <div class="dd-quick-stats">
                    <div class="dd-stat">
                        <div class="dd-stat-label">Max Drawdown</div>
                        <div class="dd-stat-value red">-77%</div>
                    </div>
                    <div class="dd-stat">
                        <div class="dd-stat-label">Duration</div>
                        <div class="dd-stat-value orange">394 days</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detail Panel (hidden by default) -->
        <div class="detail-panel" id="detail-panel">
            <div class="detail-header">
                <div class="detail-title">
                    <h2 id="detail-title">2014 Mt. Gox Collapse</h2>
                    <div class="detail-badge" id="detail-badge">-86% Peak to Trough</div>
                </div>
                <button class="close-detail" onclick="closeDetail()">‚úï Close Analysis</button>
            </div>

            <!-- Stats Row -->
            <div class="stats-grid" id="stats-grid">
                <div class="stat-card highlight">
                    <div class="stat-label">Maximum Drawdown</div>
                    <div class="stat-value red" id="stat-dd">-86.0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Peak Price</div>
                    <div class="stat-value green" id="stat-peak">$1,163</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Trough Price</div>
                    <div class="stat-value red" id="stat-trough">$162</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Duration (Days)</div>
                    <div class="stat-value orange" id="stat-duration">411</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Recovery Time</div>
                    <div class="stat-value blue" id="stat-recovery">1,186 days</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Daily Vol</div>
                    <div class="stat-value purple" id="stat-vol">4.8%</div>
                </div>
            </div>

            <!-- Detail Grid -->
            <div class="detail-grid">
                <div class="chart-card">
                    <div class="chart-card-title">
                        <span class="icon">üîç</span>
                        Zoomed Price Action
                    </div>
                    <div id="zoom-chart"></div>
                    
                    <!-- Stress Test Controls - Positioned below chart -->
                    <div class="stress-test-inline">
                        <div class="stress-test-inline-title">
                            <span>üéØ</span> Stress Test Your Position
                        </div>
                        
                        <div class="stress-inline-grid">
                            <div class="stress-control-group">
                                <span class="stress-control-label">Amplification</span>
                                <input type="range" class="stress-slider" id="stress-amp" min="5" max="100" value="25" step="1">
                                <span class="stress-control-value" id="stress-amp-value">25%</span>
                            </div>
                            
                            <div class="stress-control-group">
                                <span class="stress-control-label">Dividend Rate</span>
                                <input type="range" class="stress-slider" id="stress-div-rate" min="1" max="25" value="10" step="0.5">
                                <span class="stress-control-value" id="stress-div-value">10%</span>
                            </div>
                            
                            <div class="implied-bcr-display">
                                <span class="implied-label">Implied BCR</span>
                                <span class="implied-value" id="implied-bcr">40.0x</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="narrative-section">
                        <div class="narrative-title">
                            <span>‚ö°</span> Catalyst Analysis
                        </div>
                        <div class="narrative-text" id="catalyst-text">
                            Loading...
                        </div>
                    </div>

                    <div class="narrative-section">
                        <div class="narrative-title collapsible-header" onclick="toggleTimeline()">
                            <span>üìÖ</span> Event Timeline
                            <span class="expand-hint" id="timeline-hint">Show</span>
                            <span class="collapse-chevron" id="timeline-collapse-icon">‚Ä∫</span>
                        </div>
                        <div class="timeline collapsible-content collapsed" id="event-timeline">
                            <!-- Timeline items populated by JS -->
                        </div>
                    </div>

                    <div class="clustering-section">
                        <div class="clustering-title">üìä Behavioral Patterns</div>
                        <div class="clustering-grid" id="clustering-stats">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Stress Test Results -->
            <div class="stress-results-card" id="stress-results">
                <div class="stress-results-header">
                    <div class="stress-results-title">
                        <span>üéØ</span> Your Position vs This Drawdown
                    </div>
                    <div class="survival-badge survived" id="survival-badge">‚úì SURVIVED</div>
                </div>
                
                <div class="stress-stats-grid">
                    <div class="stress-stat">
                        <div class="stress-stat-label">Starting BCR</div>
                        <div class="stress-stat-value orange" id="stress-start-bcr">40.0x</div>
                    </div>
                    <div class="stress-stat">
                        <div class="stress-stat-label">Minimum BCR</div>
                        <div class="stress-stat-value" id="stress-min-bcr">12.4x</div>
                    </div>
                    <div class="stress-stat">
                        <div class="stress-stat-label">Ending BCR</div>
                        <div class="stress-stat-value" id="stress-end-bcr">28.7x</div>
                    </div>
                    <div class="stress-stat">
                        <div class="stress-stat-label">BTC Sold</div>
                        <div class="stress-stat-value blue" id="stress-btc-sold">18.3%</div>
                    </div>
                </div>
                
                <!-- Regime Comparison Grid -->
                <div class="regime-comparison-grid three-col">
                    <!-- CURRENT REGIME (2021-2025) -->
                    <div class="regime-section current-regime">
                        <div class="regime-header">
                            <span class="regime-icon">üìà</span>
                            <span class="regime-name">Current</span>
                            <span class="regime-dates">(2021-2025)</span>
                        </div>
                        
                        <div class="regime-models stacked">
                            <div class="mini-model">
                                <div class="mini-model-header">
                                    <span>üìä Bootstrap</span>
                                    <span class="percentile-badge" id="current-bs-badge">‚Äî%</span>
                                </div>
                                <div id="current-bs-histogram" style="height: 80px;"></div>
                            </div>
                            <div class="mini-model">
                                <div class="mini-model-header">
                                    <span>‚ö° Jump Diff</span>
                                    <span class="percentile-badge" id="current-jd-badge">‚Äî%</span>
                                </div>
                                <div id="current-jd-histogram" style="height: 80px;"></div>
                            </div>
                        </div>
                        
                        <div class="regime-summary">
                            <span class="regime-avg-label">Avg:</span>
                            <span class="regime-avg-value" id="current-avg">‚Äî%</span>
                        </div>
                    </div>
                    
                    <!-- BEAR REGIME (2018-2020) -->
                    <div class="regime-section bear-regime">
                        <div class="regime-header">
                            <span class="regime-icon">üêª</span>
                            <span class="regime-name">Bear</span>
                            <span class="regime-dates">(2018-2020)</span>
                        </div>
                        
                        <div class="regime-models stacked">
                            <div class="mini-model">
                                <div class="mini-model-header">
                                    <span>üìä Bootstrap</span>
                                    <span class="percentile-badge" id="bear-bs-badge">‚Äî%</span>
                                </div>
                                <div id="bear-bs-histogram" style="height: 80px;"></div>
                            </div>
                            <div class="mini-model">
                                <div class="mini-model-header">
                                    <span>‚ö° Jump Diff</span>
                                    <span class="percentile-badge" id="bear-jd-badge">‚Äî%</span>
                                </div>
                                <div id="bear-jd-histogram" style="height: 80px;"></div>
                            </div>
                        </div>
                        
                        <div class="regime-summary">
                            <span class="regime-avg-label">Avg:</span>
                            <span class="regime-avg-value" id="bear-avg">‚Äî%</span>
                        </div>
                    </div>
                    
                    <!-- FULL CYCLE (2014-2025) -->
                    <div class="regime-section full-regime">
                        <div class="regime-header">
                            <span class="regime-icon">üîÑ</span>
                            <span class="regime-name">Full Cycle</span>
                            <span class="regime-dates">(2014-2025)</span>
                        </div>
                        
                        <div class="regime-models stacked">
                            <div class="mini-model">
                                <div class="mini-model-header">
                                    <span>üìä Bootstrap</span>
                                    <span class="percentile-badge" id="full-bs-badge">‚Äî%</span>
                                </div>
                                <div id="full-bs-histogram" style="height: 80px;"></div>
                            </div>
                            <div class="mini-model">
                                <div class="mini-model-header">
                                    <span>‚ö° Jump Diff</span>
                                    <span class="percentile-badge" id="full-jd-badge">‚Äî%</span>
                                </div>
                                <div id="full-jd-histogram" style="height: 80px;"></div>
                            </div>
                        </div>
                        
                        <div class="regime-summary">
                            <span class="regime-avg-label">Avg:</span>
                            <span class="regime-avg-value" id="full-avg">‚Äî%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Best Fit Indicator -->
                <div class="best-fit-card" id="best-fit-card">
                    <div class="best-fit-header">
                        <span>üéØ</span> Best Historical Fit
                    </div>
                    <div class="best-fit-content" id="best-fit-content">
                        Calculating...
                    </div>
                </div>
                
                <!-- Historical Rarity Card -->
                <div class="historical-rarity-card" id="historical-rarity">
                    <div class="rarity-header">
                        <span class="rarity-icon">üìú</span>
                        <span class="rarity-title">Historical Rarity</span>
                    </div>
                    <div class="rarity-content">
                        <div class="rarity-stat">
                            <div class="rarity-stat-label">Crashes ‚â• This Severity</div>
                            <div class="rarity-stat-value" id="rarity-count">‚Äî</div>
                            <div class="rarity-stat-sublabel">in <span id="rarity-years">‚Äî</span> years of BTC history</div>
                        </div>
                        <div class="rarity-stat">
                            <div class="rarity-stat-label">Historical Frequency</div>
                            <div class="rarity-stat-value" id="rarity-frequency">‚Äî</div>
                            <div class="rarity-stat-sublabel">annual probability</div>
                        </div>
                        <div class="rarity-stat">
                            <div class="rarity-stat-label">Expected in 8-Year Horizon</div>
                            <div class="rarity-stat-value" id="rarity-expected">‚Äî</div>
                            <div class="rarity-stat-sublabel">crash events</div>
                        </div>
                    </div>
                    <div class="rarity-validation" id="rarity-validation">
                        Loading validation...
                    </div>
                </div>
                
                <!-- Summary Comparison -->
                <div class="percentile-context" id="percentile-context" style="margin-top: 15px;">
                    Loading analysis...
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // Drawdowns & Path Dependency Analysis
        // ========================================
        
        // Major drawdown event data
        const DRAWDOWN_EVENTS = {
            '2014': {
                name: 'Mt. Gox Collapse',
                peakDate: '2013-11-29',
                troughDate: '2015-01-14',
                peakPrice: 1163,
                troughPrice: 162,
                maxDrawdown: -86.0,
                durationDays: 411,
                recoveryDays: 1186,
                avgDailyVol: 4.8,
                catalyst: `The 2014 crash was triggered by the <strong>collapse of Mt. Gox</strong>, then handling ~70% of all Bitcoin transactions. In February 2014, the exchange halted withdrawals citing a "transaction malleability" bug, later revealing 850,000 BTC had been stolen over several years. This was compounded by regulatory uncertainty as China banned financial institutions from handling Bitcoin.`,
                timeline: [
                    { date: 'Nov 29, 2013', event: 'BTC peaks at $1,163 amid China speculation', type: 'peak' },
                    { date: 'Dec 5, 2013', event: 'PBoC bans financial institutions from BTC', type: 'crisis' },
                    { date: 'Feb 7, 2014', event: 'Mt. Gox halts all withdrawals', type: 'crisis' },
                    { date: 'Feb 24, 2014', event: 'Mt. Gox goes offline, files bankruptcy', type: 'crisis' },
                    { date: 'Jan 14, 2015', event: 'BTC bottoms at $162', type: 'trough' },
                    { date: 'Dec 2017', event: 'Price finally recovers to ATH', type: 'recovery' }
                ],
                clustering: {
                    'Consecutive -10% Days': '7 events',
                    'Largest Single Day Drop': '-23.4%',
                    'Days Below -50% DD': '294',
                    'Bounce Attempts (>20%)': '4',
                    'Capitulation Volume Spike': '8.2x avg',
                    'Correlation w/ S&P': '0.12'
                },
                chartRange: ['2013-10-01', '2016-01-01']
            },
            '2018': {
                name: 'ICO Bubble Burst',
                peakDate: '2017-12-17',
                troughDate: '2018-12-15',
                peakPrice: 19783,
                troughPrice: 3191,
                maxDrawdown: -83.8,
                durationDays: 364,
                recoveryDays: 1089,
                avgDailyVol: 4.2,
                catalyst: `The 2018 crash followed the <strong>ICO mania of 2017</strong> where thousands of speculative tokens raised billions. The bubble burst when the SEC began cracking down on unregistered securities offerings. The crash was accelerated by the Bitcoin Cash hash war in November 2018, and mass liquidations on newly-launched leveraged products.`,
                timeline: [
                    { date: 'Dec 17, 2017', event: 'BTC peaks at $19,783 during ICO mania', type: 'peak' },
                    { date: 'Jan 2018', event: 'South Korea announces crypto regulations', type: 'crisis' },
                    { date: 'Mar 2018', event: 'Google, Facebook ban crypto ads', type: 'crisis' },
                    { date: 'Nov 15, 2018', event: 'Bitcoin Cash hash war triggers panic', type: 'crisis' },
                    { date: 'Dec 15, 2018', event: 'BTC bottoms at $3,191', type: 'trough' },
                    { date: 'Nov 2020', event: 'Price finally recovers to ATH', type: 'recovery' }
                ],
                clustering: {
                    'Consecutive -10% Days': '5 events',
                    'Largest Single Day Drop': '-16.8%',
                    'Days Below -50% DD': '206',
                    'Bounce Attempts (>20%)': '6',
                    'Capitulation Volume Spike': '5.4x avg',
                    'Correlation w/ S&P': '0.28'
                },
                chartRange: ['2017-10-01', '2020-01-01']
            },
            '2022': {
                name: 'Fed Tightening & Contagion',
                peakDate: '2021-11-10',
                troughDate: '2022-11-21',
                peakPrice: 68789,
                troughPrice: 15476,
                maxDrawdown: -77.5,
                durationDays: 394,
                recoveryDays: 766,
                avgDailyVol: 3.6,
                catalyst: `The 2022 crash was driven by <strong>aggressive Fed rate hikes</strong> to combat inflation, causing a broad risk-off environment. The crypto-specific damage came from cascading failures: the <strong>$60B Terra/Luna collapse</strong> in May, Three Arrows Capital's bankruptcy in June, and the <strong>FTX fraud revelation</strong> in November, which destroyed confidence in centralized exchanges.`,
                timeline: [
                    { date: 'Nov 10, 2021', event: 'BTC peaks at $68,789', type: 'peak' },
                    { date: 'May 9, 2022', event: 'Terra/Luna depegs, triggers cascade', type: 'crisis' },
                    { date: 'Jun 13, 2022', event: 'Celsius halts withdrawals', type: 'crisis' },
                    { date: 'Jun 27, 2022', event: 'Three Arrows Capital files bankruptcy', type: 'crisis' },
                    { date: 'Nov 8, 2022', event: 'FTX halts withdrawals, fraud exposed', type: 'crisis' },
                    { date: 'Nov 21, 2022', event: 'BTC bottoms at $15,476', type: 'trough' },
                    { date: 'Mar 2024', event: 'Price recovers to ATH', type: 'recovery' }
                ],
                clustering: {
                    'Consecutive -10% Days': '3 events',
                    'Largest Single Day Drop': '-14.2%',
                    'Days Below -50% DD': '187',
                    'Bounce Attempts (>20%)': '3',
                    'Capitulation Volume Spike': '4.1x avg',
                    'Correlation w/ S&P': '0.67'
                },
                chartRange: ['2021-09-01', '2024-01-01']
            }
        };

        let selectedEvent = null;

        // Metric explanations for tooltips
        const METRIC_EXPLANATIONS = {
            'Consecutive -10% Days': {
                title: 'Consecutive -10% Days',
                desc: 'Number of times the price fell 10% or more on consecutive trading days during the drawdown period.',
                why: '<strong>Why it matters:</strong> Clustering of extreme losses indicates panic selling and forced liquidations‚Äîkey stress signals for leveraged treasury positions.'
            },
            'Largest Single Day Drop': {
                title: 'Largest Single Day Drop',
                desc: 'The worst single-day percentage decline during the entire drawdown event.',
                why: '<strong>Why it matters:</strong> Flash crashes can trigger margin calls and forced selling, especially for treasuries using BTC as collateral.'
            },
            'Days Below -50% DD': {
                title: 'Days Below -50% Drawdown',
                desc: 'Total number of days where price remained more than 50% below the previous all-time high.',
                why: '<strong>Why it matters:</strong> Extended periods of deep drawdown test the solvency and psychological resolve of long-term holders and institutional treasuries.'
            },
            'Bounce Attempts (>20%)': {
                title: 'Bounce Attempts (>20%)',
                desc: 'Number of rallies exceeding 20% that occurred during the drawdown before the ultimate bottom.',
                why: '<strong>Why it matters:</strong> "Bear market rallies" can trap investors and indicate ongoing volatility‚Äîuseful for modeling path dependency risk.'
            },
            'Capitulation Volume Spike': {
                title: 'Capitulation Volume Spike',
                desc: 'Peak trading volume during the drawdown expressed as a multiple of average daily volume.',
                why: '<strong>Why it matters:</strong> Volume spikes often mark capitulation events where weak hands exit, potentially signaling a bottom or acceleration of selling.'
            },
            'Correlation w/ S&P': {
                title: 'Correlation with S&P 500',
                desc: 'Rolling 30-day correlation between BTC returns and S&P 500 returns during the drawdown period.',
                why: '<strong>Why it matters:</strong> Higher correlation means BTC offers less diversification during market stress‚Äîcritical for portfolio risk assessment.'
            }
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[Drawdowns] Initializing...');
            console.log('[Drawdowns] BTC_PRICES available:', typeof window.BTC_PRICES !== 'undefined');
            console.log('[Drawdowns] Data length:', window.BTC_PRICES ? window.BTC_PRICES.length : 0);
            
            if (window.BTC_PRICES && window.BTC_PRICES.length > 100) {
                console.log('[Drawdowns] Data range:', window.BTC_PRICES[0].date, 'to', window.BTC_PRICES[window.BTC_PRICES.length-1].date);
                renderMainChart();
            } else {
                console.error('[Drawdowns] BTC data not loaded');
                document.getElementById('main-chart').innerHTML = 
                    '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--accent-red);">' +
                    '<span>Failed to load BTC data. Check console for errors.</span></div>';
            }
        });

        function renderMainChart() {
            // Get full BTC data from 2014
            const data = window.BTC_PRICES.filter(d => {
                const year = new Date(d.date).getFullYear();
                return year >= 2014;
            });

            // Main price trace
            const priceTrace = {
                x: data.map(d => d.date),
                y: data.map(d => d.price),
                type: 'scatter',
                mode: 'lines',
                name: 'BTC Price',
                line: { color: '#f7931a', width: 2 },
                hovertemplate: '%{x}<br>$%{y:,.0f}<extra></extra>'
            };

            // Highlight zones for each drawdown
            const shapes = [
                // 2014 drawdown
                {
                    type: 'rect',
                    xref: 'x', yref: 'paper',
                    x0: '2013-11-29', x1: '2015-01-14',
                    y0: 0, y1: 1,
                    fillcolor: 'rgba(255, 71, 87, 0.15)',
                    line: { width: 0 }
                },
                // 2018 drawdown  
                {
                    type: 'rect',
                    xref: 'x', yref: 'paper',
                    x0: '2017-12-17', x1: '2018-12-15',
                    y0: 0, y1: 1,
                    fillcolor: 'rgba(168, 85, 247, 0.15)',
                    line: { width: 0 }
                },
                // 2022 drawdown
                {
                    type: 'rect',
                    xref: 'x', yref: 'paper',
                    x0: '2021-11-10', x1: '2022-11-21',
                    y0: 0, y1: 1,
                    fillcolor: 'rgba(74, 158, 255, 0.15)',
                    line: { width: 0 }
                }
            ];

            // Annotations for peaks
            const annotations = [
                { x: '2013-11-29', y: 1163, text: '2014', showarrow: true, arrowhead: 0, ax: 0, ay: -40, font: { color: '#ff4757', size: 14, family: 'JetBrains Mono' } },
                { x: '2017-12-17', y: 19783, text: '2018', showarrow: true, arrowhead: 0, ax: 0, ay: -40, font: { color: '#a855f7', size: 14, family: 'JetBrains Mono' } },
                { x: '2021-11-10', y: 68789, text: '2022', showarrow: true, arrowhead: 0, ax: 0, ay: -40, font: { color: '#4a9eff', size: 14, family: 'JetBrains Mono' } }
            ];

            Plotly.newPlot('main-chart', [priceTrace], {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { family: 'Space Grotesk', color: '#a0a0b0' },
                margin: { t: 30, r: 50, b: 50, l: 80 },
                xaxis: {
                    gridcolor: '#2a2a3a',
                    showgrid: true,
                    tickfont: { size: 11 }
                },
                yaxis: {
                    gridcolor: '#2a2a3a',
                    type: 'log',
                    tickprefix: '$',
                    tickfont: { size: 11 },
                    showgrid: true
                },
                shapes: shapes,
                annotations: annotations,
                hovermode: 'x unified',
                showlegend: false
            }, { 
                responsive: true,
                displayModeBar: false
            });

            // Position the clickable zone overlays after chart renders
            setTimeout(positionZoneOverlays, 100);
            
            // Reposition on window resize
            window.addEventListener('resize', () => setTimeout(positionZoneOverlays, 50));
            
            // Also reposition after any Plotly relayout
            const chartEl = document.getElementById('main-chart');
            chartEl.on('plotly_relayout', () => setTimeout(positionZoneOverlays, 50));
        }
        
        function positionZoneOverlays() {
            const chartEl = document.getElementById('main-chart');
            if (!chartEl || !chartEl._fullLayout) return;
            
            const layout = chartEl._fullLayout;
            const xaxis = layout.xaxis;
            const plotArea = layout._size;
            
            // Chart dimensions
            const chartLeft = plotArea.l;
            const chartWidth = plotArea.w;
            const chartTop = plotArea.t;
            const chartHeight = plotArea.h;
            
            // Date range of the full chart
            const xMin = new Date(xaxis.range[0]).getTime();
            const xMax = new Date(xaxis.range[1]).getTime();
            const xRange = xMax - xMin;
            
            // Zone date ranges
            const zones = [
                { el: document.querySelector('.zone-2014'), start: '2013-11-29', end: '2015-01-14' },
                { el: document.querySelector('.zone-2018'), start: '2017-12-17', end: '2018-12-15' },
                { el: document.querySelector('.zone-2022'), start: '2021-11-10', end: '2022-11-21' }
            ];
            
            zones.forEach(zone => {
                if (!zone.el) return;
                
                const startTime = new Date(zone.start).getTime();
                const endTime = new Date(zone.end).getTime();
                
                // Calculate pixel positions
                const leftPct = (startTime - xMin) / xRange;
                const rightPct = (endTime - xMin) / xRange;
                
                const leftPx = chartLeft + (leftPct * chartWidth);
                const widthPx = (rightPct - leftPct) * chartWidth;
                
                // Apply styles
                zone.el.style.left = leftPx + 'px';
                zone.el.style.width = widthPx + 'px';
                zone.el.style.top = chartTop + 'px';
                zone.el.style.height = chartHeight + 'px';
            });
        }
        
        // Toggle timeline collapse
        function toggleTimeline() {
            const content = document.getElementById('event-timeline');
            const icon = document.getElementById('timeline-collapse-icon');
            const hint = document.getElementById('timeline-hint');
            
            const isCollapsed = content.classList.toggle('collapsed');
            icon.classList.toggle('expanded', !isCollapsed);
            hint.textContent = isCollapsed ? 'Show' : 'Hide';
        }

        function selectDrawdown(year) {
            selectedEvent = DRAWDOWN_EVENTS[year];
            
            // Update card active state
            document.querySelectorAll('.dd-card').forEach(card => card.classList.remove('active'));
            document.querySelector(`.dd-${year}`).classList.add('active');
            
            // Show and populate detail panel
            document.getElementById('detail-panel').classList.add('active');
            
            // Update header
            document.getElementById('detail-title').textContent = `${year} ${selectedEvent.name}`;
            document.getElementById('detail-badge').textContent = `${selectedEvent.maxDrawdown.toFixed(1)}% Peak to Trough`;
            
            // Update stats
            document.getElementById('stat-dd').textContent = `${selectedEvent.maxDrawdown.toFixed(1)}%`;
            document.getElementById('stat-peak').textContent = `$${selectedEvent.peakPrice.toLocaleString()}`;
            document.getElementById('stat-trough').textContent = `$${selectedEvent.troughPrice.toLocaleString()}`;
            document.getElementById('stat-duration').textContent = selectedEvent.durationDays;
            document.getElementById('stat-recovery').textContent = `${selectedEvent.recoveryDays.toLocaleString()} days`;
            document.getElementById('stat-vol').textContent = `${selectedEvent.avgDailyVol}%`;
            
            // Update catalyst text
            document.getElementById('catalyst-text').innerHTML = selectedEvent.catalyst;
            
            // Update timeline
            const timelineHtml = selectedEvent.timeline.map(item => `
                <div class="timeline-item ${item.type === 'recovery' ? 'recovery' : ''}">
                    <div class="timeline-date">${item.date}</div>
                    <div class="timeline-event">${item.event}</div>
                </div>
            `).join('');
            document.getElementById('event-timeline').innerHTML = timelineHtml;
            
            // Update clustering stats with info tooltips
            const clusteringHtml = Object.entries(selectedEvent.clustering).map(([key, value]) => {
                const explanation = METRIC_EXPLANATIONS[key] || { title: key, desc: '', why: '' };
                return `
                <div class="clustering-item">
                    <span class="clustering-label">
                        ${key}
                        <span class="info-icon">?</span>
                        <div class="metric-tooltip">
                            <div class="tooltip-title">${explanation.title}</div>
                            <div class="tooltip-desc">${explanation.desc}</div>
                            <div class="tooltip-why">${explanation.why}</div>
                        </div>
                    </span>
                    <span class="clustering-value">${value}</span>
                </div>
            `}).join('');
            document.getElementById('clustering-stats').innerHTML = clusteringHtml;
            
            // Render zoomed chart
            renderZoomChart(selectedEvent);
            
            // Scroll to detail panel
            document.getElementById('detail-panel').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function renderZoomChart(event) {
            const [startDate, endDate] = event.chartRange;
            
            const data = window.BTC_PRICES.filter(d => {
                return d.date >= startDate && d.date <= endDate;
            });
            
            // Calculate drawdown from ATH within this window
            let ath = 0;
            const ddData = data.map(d => {
                if (d.price > ath) ath = d.price;
                return { date: d.date, price: d.price, dd: ((d.price - ath) / ath) * 100 };
            });

            // Price trace
            const priceTrace = {
                x: data.map(d => d.date),
                y: data.map(d => d.price),
                type: 'scatter',
                mode: 'lines',
                name: 'Price',
                line: { color: '#f7931a', width: 2 },
                yaxis: 'y',
                hovertemplate: '$%{y:,.0f}<extra>Price</extra>'
            };

            // Drawdown trace
            const ddTrace = {
                x: ddData.map(d => d.date),
                y: ddData.map(d => d.dd),
                type: 'scatter',
                mode: 'lines',
                name: 'Drawdown',
                fill: 'tozeroy',
                fillcolor: 'rgba(255, 71, 87, 0.2)',
                line: { color: '#ff4757', width: 1 },
                yaxis: 'y2',
                hovertemplate: '%{y:.1f}%<extra>Drawdown</extra>'
            };

            Plotly.newPlot('zoom-chart', [priceTrace, ddTrace], {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { family: 'Space Grotesk', color: '#a0a0b0' },
                margin: { t: 20, r: 60, b: 40, l: 70 },
                xaxis: {
                    gridcolor: '#2a2a3a',
                    tickfont: { size: 10 }
                },
                yaxis: {
                    gridcolor: '#2a2a3a',
                    type: 'log',
                    tickprefix: '$',
                    tickfont: { size: 10 },
                    side: 'left'
                },
                yaxis2: {
                    overlaying: 'y',
                    side: 'right',
                    ticksuffix: '%',
                    tickfont: { size: 10, color: '#ff4757' },
                    showgrid: false,
                    range: [-100, 10],
                    zeroline: false
                },
                legend: { x: 0.02, y: 0.98, bgcolor: 'rgba(0,0,0,0.5)', font: { size: 10 } },
                hovermode: 'x unified',
                shapes: [
                    // Peak marker
                    { type: 'line', x0: event.peakDate, x1: event.peakDate, y0: 0, y1: 1, yref: 'paper', line: { color: '#00d4aa', width: 1, dash: 'dot' } },
                    // Trough marker
                    { type: 'line', x0: event.troughDate, x1: event.troughDate, y0: 0, y1: 1, yref: 'paper', line: { color: '#ff4757', width: 1, dash: 'dot' } }
                ]
            }, { 
                responsive: true,
                displayModeBar: false 
            });
        }

        function closeDetail() {
            document.getElementById('detail-panel').classList.remove('active');
            document.querySelectorAll('.dd-card').forEach(card => card.classList.remove('active'));
            selectedEvent = null;
            
            // Scroll back to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // ========================================
        // STRESS TEST FUNCTIONALITY
        // ========================================
        
        // Setup stress test controls
        function initStressTestControls() {
            const ampSlider = document.getElementById('stress-amp');
            const ampValue = document.getElementById('stress-amp-value');
            const divSlider = document.getElementById('stress-div-rate');
            const divValue = document.getElementById('stress-div-value');
            const impliedBcr = document.getElementById('implied-bcr');
            
            function updateImpliedBCR() {
                const amp = parseFloat(ampSlider.value) / 100; // Convert % to decimal
                const divRate = parseFloat(divSlider.value) / 100;
                
                // BCR = 1 / (Amplification √ó DivRate)
                const bcr = 1 / (amp * divRate);
                impliedBcr.textContent = bcr.toFixed(1) + 'x';
                
                // If a drawdown is selected, update the stress test
                if (selectedEvent) {
                    runStressTest(selectedEvent);
                }
            }
            
            ampSlider.addEventListener('input', () => {
                ampValue.textContent = ampSlider.value + '%';
                updateImpliedBCR();
            });
            
            divSlider.addEventListener('input', () => {
                divValue.textContent = divSlider.value + '%';
                updateImpliedBCR();
            });
            
            // Initial calculation
            updateImpliedBCR();
        }
        
        // Run stress test for a specific drawdown
        function runStressTest(event) {
            const amp = parseFloat(document.getElementById('stress-amp').value) / 100; // Convert % to decimal
            const divRate = parseFloat(document.getElementById('stress-div-rate').value) / 100;
            
            // Calculate BCR from amplification: BCR = 1 / (Amp √ó DivRate)
            const targetBCR = 1 / (amp * divRate);
            
            // Get price data for this drawdown period
            const startDate = event.peakDate;
            const endDate = event.troughDate;
            
            const priceData = window.BTC_PRICES.filter(d => {
                return d.date >= startDate && d.date <= endDate;
            });
            
            if (priceData.length < 10) {
                console.error('Not enough price data for stress test');
                return;
            }
            
            // === VERIFICATION LOGGING ===
            console.log('=== STRESS TEST VERIFICATION ===');
            console.log(`Event: ${event.name}`);
            console.log(`Duration: ${priceData.length} days`);
            console.log(`Start Price: $${priceData[0].price.toLocaleString()}`);
            console.log(`End Price: $${priceData[priceData.length-1].price.toLocaleString()}`);
            console.log(`Target BCR: ${targetBCR}x, Div Rate: ${(divRate*100).toFixed(1)}%`);
            
            // Simulate treasury through this period
            const result = simulateTreasury(priceData, targetBCR, divRate);
            
            console.log(`--- Historical Result ---`);
            console.log(`Max Drawdown: ${result.maxDrawdown.toFixed(1)}%`);
            console.log(`Min BCR: ${result.minBCR.toFixed(2)}x`);
            console.log(`End BCR: ${result.endBCR.toFixed(2)}x`);
            console.log(`BTC Sold: ${result.btcSoldPct.toFixed(2)}%`);
            console.log(`Survived: ${result.survived}`);
            
            // Run ALL models for comparison (3 regimes √ó 2 models = 6 total)
            console.log(`\n--- Running Models (${priceData.length} day horizon) ---`);
            
            // Current Regime (2021-2025)
            const currentBootstrap = runBlockBootstrap(priceData.length, divRate, targetBCR, 1000, 'current');
            const currentJump = runJumpDiffusion(priceData.length, divRate, targetBCR, 1000, 'current');
            
            // Bear Regime (2018-2020)
            const bearBootstrap = runBlockBootstrap(priceData.length, divRate, targetBCR, 1000, 'bear');
            const bearJump = runJumpDiffusion(priceData.length, divRate, targetBCR, 1000, 'bear');
            
            // Full Cycle (2014-2025)
            const fullBootstrap = runBlockBootstrap(priceData.length, divRate, targetBCR, 1000, 'full');
            const fullJump = runJumpDiffusion(priceData.length, divRate, targetBCR, 1000, 'full');
            
            // Calculate percentiles for all models
            const currentBsBcr = calculatePercentile(currentBootstrap.minBCRs, result.minBCR);
            const currentJdBcr = calculatePercentile(currentJump.minBCRs, result.minBCR);
            
            const bearBsBcr = calculatePercentile(bearBootstrap.minBCRs, result.minBCR);
            const bearJdBcr = calculatePercentile(bearJump.minBCRs, result.minBCR);
            
            const fullBsBcr = calculatePercentile(fullBootstrap.minBCRs, result.minBCR);
            const fullJdBcr = calculatePercentile(fullJump.minBCRs, result.minBCR);
            
            console.log(`\n--- CURRENT REGIME (2021-2025) ---`);
            console.log(`Block Bootstrap: BCR ${currentBsBcr.toFixed(0)}%ile`);
            console.log(`Jump Diffusion: BCR ${currentJdBcr.toFixed(0)}%ile`);
            
            console.log(`\n--- BEAR REGIME (2018-2020) ---`);
            console.log(`Block Bootstrap: BCR ${bearBsBcr.toFixed(0)}%ile`);
            console.log(`Jump Diffusion: BCR ${bearJdBcr.toFixed(0)}%ile`);
            
            console.log(`\n--- FULL CYCLE (2014-2025) ---`);
            console.log(`Block Bootstrap: BCR ${fullBsBcr.toFixed(0)}%ile`);
            console.log(`Jump Diffusion: BCR ${fullJdBcr.toFixed(0)}%ile`);
            console.log('================================');
            
            // Update UI with all model comparisons
            updateStressTestUI(result, {
                current: {
                    bootstrap: { bcr: currentBsBcr, data: currentBootstrap },
                    jump: { bcr: currentJdBcr, data: currentJump }
                },
                bear: {
                    bootstrap: { bcr: bearBsBcr, data: bearBootstrap },
                    jump: { bcr: bearJdBcr, data: bearJump }
                },
                full: {
                    bootstrap: { bcr: fullBsBcr, data: fullBootstrap },
                    jump: { bcr: fullJdBcr, data: fullJump }
                }
            }, event);
        }
        
        // Simulate treasury through historical period
        function simulateTreasury(priceData, targetBCR, divRate) {
            const startPrice = priceData[0].price;
            const monthlyDivRate = divRate / 12;
            
            // Start with 1 BTC, BCR determines initial capital structure
            let btcHoldings = 1;
            const initialNav = btcHoldings * startPrice;
            const annualDividend = initialNav / targetBCR;
            const monthlyDividend = annualDividend / 12;
            
            let minBCR = targetBCR;
            let totalBtcSold = 0;
            let failed = false;
            let currentBCR = targetBCR;
            
            // Simulate day by day
            let daysSinceLastDiv = 0;
            
            for (let i = 1; i < priceData.length; i++) {
                const price = priceData[i].price;
                daysSinceLastDiv++;
                
                // Pay dividend monthly (every ~30 days)
                if (daysSinceLastDiv >= 30) {
                    const btcToSell = monthlyDividend / price;
                    btcHoldings -= btcToSell;
                    totalBtcSold += btcToSell;
                    daysSinceLastDiv = 0;
                    
                    if (btcHoldings <= 0) {
                        failed = true;
                        break;
                    }
                }
                
                // Calculate current BCR
                const currentNav = btcHoldings * price;
                currentBCR = currentNav / annualDividend;
                
                if (currentBCR < minBCR) {
                    minBCR = currentBCR;
                }
                
                if (currentBCR < 1) {
                    failed = true;
                    break;
                }
            }
            
            const endPrice = priceData[priceData.length - 1].price;
            const endNav = btcHoldings * endPrice;
            const endBCR = endNav / annualDividend;
            
            // Calculate max drawdown from price data
            let peak = priceData[0].price;
            let maxDrawdown = 0;
            for (let i = 1; i < priceData.length; i++) {
                if (priceData[i].price > peak) peak = priceData[i].price;
                const dd = (peak - priceData[i].price) / peak * 100;
                if (dd > maxDrawdown) maxDrawdown = dd;
            }
            
            return {
                startBCR: targetBCR,
                minBCR: minBCR,
                endBCR: failed ? 0 : endBCR,
                btcSoldPct: totalBtcSold * 100,
                survived: !failed,
                maxDrawdown: maxDrawdown
            };
        }
        
        // ========================================
        // REGIME DEFINITIONS
        // ========================================
        const REGIMES = {
            current: { name: 'Current (2021-2025)', start: '2021-01-01', end: '2025-12-31', color: '#a855f7' },
            bear: { name: 'Bear (2018-2020)', start: '2018-01-01', end: '2020-12-31', color: '#ef4444' },
            full: { name: 'Full Cycle (2014-2025)', start: '2014-01-01', end: '2025-12-31', color: '#fbbf24' }
        };
        
        // ========================================
        // BLOCK BOOTSTRAP - Configurable Regime
        // ========================================
        function runBlockBootstrap(horizonDays, divRate, targetBCR, nSims, regime = 'current') {
            const regimeConfig = REGIMES[regime];
            const REGIME_START = regimeConfig.start;
            const REGIME_END = regimeConfig.end;
            
            const allData = window.BTC_PRICES;
            const regimeData = allData.filter(d => d.date >= REGIME_START && d.date <= REGIME_END);
            
            // Calculate returns from regime data only
            const returns = [];
            for (let i = 1; i < regimeData.length; i++) {
                if (regimeData[i].price > 0 && regimeData[i-1].price > 0) {
                    returns.push(Math.log(regimeData[i].price / regimeData[i-1].price));
                }
            }
            
            console.log(`[Block Bootstrap] Using ${returns.length} days from ${regimeConfig.name}`);
            
            const blockSize = 21; // ~1 month blocks
            const minBCRs = [];
            const maxDrawdowns = [];
            
            for (let sim = 0; sim < nSims; sim++) {
                // Generate price path using block bootstrap
                const pricePath = [100]; // Start at normalized price
                let remaining = horizonDays;
                
                while (remaining > 0) {
                    // Random block start from REGIME data only
                    const blockStart = Math.floor(Math.random() * Math.max(1, returns.length - blockSize));
                    const blockLen = Math.min(blockSize, remaining);
                    
                    for (let j = 0; j < blockLen && (blockStart + j) < returns.length; j++) {
                        const ret = returns[blockStart + j];
                        const newPrice = pricePath[pricePath.length - 1] * Math.exp(ret);
                        pricePath.push(newPrice);
                    }
                    remaining -= blockLen;
                }
                
                // Calculate max drawdown and min BCR
                const result = simulatePath(pricePath, targetBCR);
                maxDrawdowns.push(result.maxDrawdown);
                minBCRs.push(result.minBCR);
            }
            
            return {
                model: `Block Bootstrap ${regimeConfig.name}`,
                regime: regime,
                minBCRs: minBCRs.sort((a, b) => a - b),
                maxDrawdowns: maxDrawdowns.sort((a, b) => a - b)
            };
        }

        // ========================================
        // JUMP DIFFUSION (Merton Model) - Configurable Regime
        // ========================================
        function runJumpDiffusion(horizonDays, divRate, targetBCR, nSims, regime = 'current') {
            const regimeConfig = REGIMES[regime];
            const REGIME_START = regimeConfig.start;
            const REGIME_END = regimeConfig.end;
            
            const allData = window.BTC_PRICES;
            const regimeData = allData.filter(d => d.date >= REGIME_START && d.date <= REGIME_END);
            
            // Calculate daily log returns
            const returns = [];
            for (let i = 1; i < regimeData.length; i++) {
                if (regimeData[i].price > 0 && regimeData[i-1].price > 0) {
                    returns.push(Math.log(regimeData[i].price / regimeData[i-1].price));
                }
            }
            
            // Calibrate parameters from regime data
            const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
            const variance = returns.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / returns.length;
            const dailyVol = Math.sqrt(variance);
            
            // Identify jumps (returns > 2 std devs)
            const jumpThreshold = 2 * dailyVol;
            const jumps = returns.filter(r => Math.abs(r) > jumpThreshold);
            const nonJumps = returns.filter(r => Math.abs(r) <= jumpThreshold);
            
            // Jump parameters
            const lambda = jumps.length / returns.length; // Daily jump probability
            const jumpMean = jumps.length > 0 ? jumps.reduce((a, b) => a + b, 0) / jumps.length : -0.05;
            const jumpStd = jumps.length > 1 ? Math.sqrt(jumps.reduce((a, b) => a + Math.pow(b - jumpMean, 2), 0) / jumps.length) : 0.10;
            
            // Diffusion parameters (from non-jump returns)
            const diffMean = nonJumps.length > 0 ? nonJumps.reduce((a, b) => a + b, 0) / nonJumps.length : mean;
            const diffVar = nonJumps.length > 0 ? nonJumps.reduce((a, b) => a + Math.pow(b - diffMean, 2), 0) / nonJumps.length : variance;
            const sigma = Math.sqrt(diffVar);
            
            // Drift adjusted for jumps
            const mu = diffMean - lambda * jumpMean;
            
            console.log(`[Jump Diffusion] Calibrated from ${regimeConfig.name}:`);
            console.log(`  Daily vol (œÉ): ${(sigma * 100).toFixed(2)}%`);
            console.log(`  Jump prob (Œª): ${(lambda * 100).toFixed(2)}%/day`);
            console.log(`  Jump mean: ${(jumpMean * 100).toFixed(2)}%`);
            console.log(`  Jump std: ${(jumpStd * 100).toFixed(2)}%`);
            
            const minBCRs = [];
            const maxDrawdowns = [];
            
            // Box-Muller for normal random
            function randn() {
                let u = 0, v = 0;
                while (u === 0) u = Math.random();
                while (v === 0) v = Math.random();
                return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
            }
            
            for (let sim = 0; sim < nSims; sim++) {
                const pricePath = [100];
                
                for (let day = 0; day < horizonDays; day++) {
                    const prevPrice = pricePath[pricePath.length - 1];
                    
                    // Diffusion component
                    const diffusion = mu + sigma * randn();
                    
                    // Jump component (Poisson process)
                    let jump = 0;
                    if (Math.random() < lambda) {
                        jump = jumpMean + jumpStd * randn();
                    }
                    
                    const dailyReturn = diffusion + jump;
                    const newPrice = prevPrice * Math.exp(dailyReturn);
                    pricePath.push(Math.max(0.01, newPrice)); // Floor at near-zero
                }
                
                // Calculate max drawdown and min BCR
                const result = simulatePath(pricePath, targetBCR);
                maxDrawdowns.push(result.maxDrawdown);
                minBCRs.push(result.minBCR);
            }
            
            return {
                model: `Jump Diffusion ${regimeConfig.name}`,
                regime: regime,
                minBCRs: minBCRs.sort((a, b) => a - b),
                maxDrawdowns: maxDrawdowns.sort((a, b) => a - b)
            };
        }
        
        // ========================================
        // Shared: Simulate path and extract metrics
        // ========================================
        function simulatePath(pricePath, targetBCR) {
            // Calculate max drawdown
            let peak = pricePath[0];
            let maxDD = 0;
            for (let i = 1; i < pricePath.length; i++) {
                if (pricePath[i] > peak) peak = pricePath[i];
                const dd = (peak - pricePath[i]) / peak * 100;
                if (dd > maxDD) maxDD = dd;
            }
            
            // Simulate treasury BCR
            let btc = 1;
            const initialNav = btc * pricePath[0];
            const annualDiv = initialNav / targetBCR;
            const monthlyDiv = annualDiv / 12;
            let minBCR = targetBCR;
            let daysSinceDiv = 0;
            
            for (let i = 1; i < pricePath.length; i++) {
                daysSinceDiv++;
                if (daysSinceDiv >= 30) {
                    btc -= monthlyDiv / pricePath[i];
                    daysSinceDiv = 0;
                    if (btc <= 0) {
                        minBCR = 0;
                        break;
                    }
                }
                
                const nav = btc * pricePath[i];
                const bcr = nav / annualDiv;
                if (bcr < minBCR) minBCR = bcr;
                if (bcr < 1) {
                    minBCR = Math.min(minBCR, bcr);
                    break;
                }
            }
            
            return {
                maxDrawdown: maxDD,
                minBCR: Math.max(0, minBCR)
            };
        }
        
        // Calculate percentile
        function calculatePercentile(sortedArray, value) {
            let count = 0;
            for (let i = 0; i < sortedArray.length; i++) {
                if (sortedArray[i] < value) count++;
                else break;
            }
            return (count / sortedArray.length) * 100;
        }
        
        // ========================================
        // HISTORICAL RARITY CALCULATION
        // ========================================
        // Major drawdown events with their severities
        const HISTORICAL_CRASHES = [
            { year: 2011, maxDD: 93, duration: 163 },  // Early crash
            { year: 2014, maxDD: 86, duration: 411 },  // Mt. Gox
            { year: 2018, maxDD: 84, duration: 364 },  // ICO Bubble
            { year: 2022, maxDD: 77, duration: 394 },  // Fed/Contagion
        ];
        
        const BTC_HISTORY_START = 2011; // First major trading
        const CURRENT_YEAR = new Date().getFullYear();
        const YEARS_OF_HISTORY = CURRENT_YEAR - BTC_HISTORY_START;
        
        function calculateHistoricalRarity(drawdownSeverity) {
            // Count how many historical crashes were at least this severe
            const crashesThisSevere = HISTORICAL_CRASHES.filter(c => c.maxDD >= Math.abs(drawdownSeverity));
            const count = crashesThisSevere.length;
            
            // Calculate annual probability
            const annualProb = count / YEARS_OF_HISTORY;
            
            // Expected crashes in 8-year horizon
            const expected8Year = annualProb * 8;
            
            return {
                count: count,
                yearsOfHistory: YEARS_OF_HISTORY,
                annualProbability: annualProb * 100, // as percentage
                expected8Year: expected8Year,
                crashes: crashesThisSevere
            };
        }
        
        function updateHistoricalRarity(event, mcAvgPct) {
            const rarity = calculateHistoricalRarity(event.maxDrawdown);
            
            // Update display
            document.getElementById('rarity-count').textContent = rarity.count;
            document.getElementById('rarity-years').textContent = rarity.yearsOfHistory;
            document.getElementById('rarity-frequency').textContent = rarity.annualProbability.toFixed(1) + '%';
            document.getElementById('rarity-expected').textContent = rarity.expected8Year.toFixed(1);
            
            // Calculate what MC says vs historical frequency
            // MC percentile = % of paths that are worse
            // If MC says 5% of 8-year paths hit this severity, that implies ~0.6% annual
            const mcImpliedAnnual = mcAvgPct / 8; // rough approximation
            
            // Comparison ratio
            const ratio = rarity.annualProbability / Math.max(mcImpliedAnnual, 0.1);
            
            let validationHTML = '';
            
            if (ratio > 5) {
                // MC severely underestimates
                validationHTML = `
                    <strong>Model Validation:</strong> Historical data shows <strong>${rarity.annualProbability.toFixed(1)}%</strong> annual probability of crashes ‚â•${Math.abs(event.maxDrawdown).toFixed(0)}%. 
                    Monte Carlo implies ~<strong>${mcImpliedAnnual.toFixed(1)}%</strong> annual probability.
                    <br><br>
                    <span class="mismatch">‚ö†Ô∏è MC underestimates frequency by ~${ratio.toFixed(0)}x.</span> 
                    Historical crashes of this severity occur <strong>1 every ${(1/rarity.annualProbability * 100).toFixed(1)} years</strong> on average.
                `;
            } else if (ratio > 2) {
                // MC moderately underestimates
                validationHTML = `
                    <strong>Model Validation:</strong> Historical: <strong>${rarity.annualProbability.toFixed(1)}%</strong>/year vs MC implied: <strong>${mcImpliedAnnual.toFixed(1)}%</strong>/year.
                    <br><br>
                    <span style="color: #fbbf24;">‚ö†Ô∏è MC may underestimate by ~${ratio.toFixed(1)}x.</span> 
                    Consider this when setting BCR buffers.
                `;
            } else if (ratio >= 0.5) {
                // Reasonable match
                validationHTML = `
                    <strong>Model Validation:</strong> Historical: <strong>${rarity.annualProbability.toFixed(1)}%</strong>/year. MC implied: <strong>${mcImpliedAnnual.toFixed(1)}%</strong>/year.
                    <br><br>
                    <span class="match">‚úì MC frequency roughly aligns with historical occurrence.</span> 
                    Model appears reasonably calibrated for this severity level.
                `;
            } else {
                // MC overestimates (unusual)
                validationHTML = `
                    <strong>Model Validation:</strong> Historical: <strong>${rarity.annualProbability.toFixed(1)}%</strong>/year. MC implied: <strong>${mcImpliedAnnual.toFixed(1)}%</strong>/year.
                    <br><br>
                    <span class="match">MC may be conservative</span> ‚Äî producing more severe scenarios than historical frequency suggests.
                `;
            }
            
            document.getElementById('rarity-validation').innerHTML = validationHTML;
        }
        
        // Update stress test UI with both regime comparisons
        function updateStressTestUI(result, models, event) {
            // Update stats
            document.getElementById('stress-start-bcr').textContent = result.startBCR.toFixed(1) + 'x';
            
            const minBcrEl = document.getElementById('stress-min-bcr');
            minBcrEl.textContent = result.minBCR.toFixed(1) + 'x';
            minBcrEl.className = 'stress-stat-value ' + (result.minBCR < 5 ? 'red' : result.minBCR < 15 ? 'orange' : 'green');
            
            const endBcrEl = document.getElementById('stress-end-bcr');
            endBcrEl.textContent = result.survived ? result.endBCR.toFixed(1) + 'x' : 'FAILED';
            endBcrEl.className = 'stress-stat-value ' + (result.survived ? 'green' : 'red');
            
            document.getElementById('stress-btc-sold').textContent = result.btcSoldPct.toFixed(1) + '%';
            
            // Update survival badge
            const badge = document.getElementById('survival-badge');
            if (result.survived) {
                badge.textContent = '‚úì SURVIVED';
                badge.className = 'survival-badge survived';
            } else {
                badge.textContent = '‚úó FAILED';
                badge.className = 'survival-badge failed';
            }
            
            // ===== CURRENT REGIME =====
            const currentAvg = (models.current.bootstrap.bcr + models.current.jump.bcr) / 2;
            document.getElementById('current-bs-badge').textContent = models.current.bootstrap.bcr.toFixed(0) + '%';
            document.getElementById('current-jd-badge').textContent = models.current.jump.bcr.toFixed(0) + '%';
            document.getElementById('current-avg').textContent = currentAvg.toFixed(0) + '%';
            
            renderHistogram('current-bs-histogram', models.current.bootstrap.data.minBCRs, result.minBCR, '#a855f7', 'x', false);
            renderHistogram('current-jd-histogram', models.current.jump.data.minBCRs, result.minBCR, '#a855f7', 'x', false);
            
            // ===== BEAR REGIME =====
            const bearAvg = (models.bear.bootstrap.bcr + models.bear.jump.bcr) / 2;
            document.getElementById('bear-bs-badge').textContent = models.bear.bootstrap.bcr.toFixed(0) + '%';
            document.getElementById('bear-jd-badge').textContent = models.bear.jump.bcr.toFixed(0) + '%';
            document.getElementById('bear-avg').textContent = bearAvg.toFixed(0) + '%';
            
            renderHistogram('bear-bs-histogram', models.bear.bootstrap.data.minBCRs, result.minBCR, '#ef4444', 'x', false);
            renderHistogram('bear-jd-histogram', models.bear.jump.data.minBCRs, result.minBCR, '#ef4444', 'x', false);
            
            // ===== FULL CYCLE =====
            const fullAvg = (models.full.bootstrap.bcr + models.full.jump.bcr) / 2;
            document.getElementById('full-bs-badge').textContent = models.full.bootstrap.bcr.toFixed(0) + '%';
            document.getElementById('full-jd-badge').textContent = models.full.jump.bcr.toFixed(0) + '%';
            document.getElementById('full-avg').textContent = fullAvg.toFixed(0) + '%';
            
            renderHistogram('full-bs-histogram', models.full.bootstrap.data.minBCRs, result.minBCR, '#fbbf24', 'x', false);
            renderHistogram('full-jd-histogram', models.full.jump.data.minBCRs, result.minBCR, '#fbbf24', 'x', false);
            
            // ===== BEST FIT CALCULATION =====
            // Historical frequency: ~27% annual for crashes ‚â•75%
            const historicalAnnualPct = 27; // approximately 3 crashes in 11 years
            const horizon = 8; // years
            const historicalExpected = historicalAnnualPct * horizon / 100; // ~2.2 crashes expected
            
            // Convert regime avg % to implied annual probability (rough)
            // If X% of 8-year paths hit this severity, annual prob ‚âà X/8
            const currentImpliedAnnual = currentAvg / horizon;
            const bearImpliedAnnual = bearAvg / horizon;
            const fullImpliedAnnual = fullAvg / horizon;
            
            // Calculate error vs historical
            const currentError = Math.abs(currentImpliedAnnual - historicalAnnualPct);
            const bearError = Math.abs(bearImpliedAnnual - historicalAnnualPct);
            const fullError = Math.abs(fullImpliedAnnual - historicalAnnualPct);
            
            // Find best fit
            let bestFit = 'full';
            let bestFitName = 'Full Cycle (2014-2025)';
            let bestFitAvg = fullAvg;
            let bestFitImplied = fullImpliedAnnual;
            
            if (bearError < fullError && bearError < currentError) {
                bestFit = 'bear';
                bestFitName = 'Bear (2018-2020)';
                bestFitAvg = bearAvg;
                bestFitImplied = bearImpliedAnnual;
            } else if (currentError < fullError && currentError < bearError) {
                bestFit = 'current';
                bestFitName = 'Current (2021-2025)';
                bestFitAvg = currentAvg;
                bestFitImplied = currentImpliedAnnual;
            }
            
            // Generate best fit content
            const bestFitHTML = `
                <span class="regime-winner">${bestFitName}</span> best matches historical crash frequency.
                <br><br>
                <strong>Comparison:</strong><br>
                ‚Ä¢ Historical: <strong>${historicalAnnualPct}%</strong> annual probability<br>
                ‚Ä¢ Current Regime implies: ${currentImpliedAnnual.toFixed(1)}%/year ${currentError < 10 ? '‚úì' : ''}<br>
                ‚Ä¢ Bear Regime implies: ${bearImpliedAnnual.toFixed(1)}%/year ${bearError < 10 ? '‚úì' : ''}<br>
                ‚Ä¢ Full Cycle implies: ${fullImpliedAnnual.toFixed(1)}%/year ${fullError < 10 ? '‚úì' : ''}
            `;
            document.getElementById('best-fit-content').innerHTML = bestFitHTML;
            
            // Generate comparison insight based on ALL regimes
            const currentMax = Math.max(models.current.bootstrap.bcr, models.current.jump.bcr);
            const bearMax = Math.max(models.bear.bootstrap.bcr, models.bear.jump.bcr);
            const fullMax = Math.max(models.full.bootstrap.bcr, models.full.jump.bcr);
            
            let comparisonInsight = '';
            const allMax = Math.max(currentMax, bearMax, fullMax);
            
            if (allMax < 5) {
                // All regimes fail
                comparisonInsight = `<div class="comparison-insight" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(239, 68, 68, 0.05) 100%); border-color: rgba(239, 68, 68, 0.4);">
                    <div class="comparison-insight-title" style="color: #ef4444;">‚ö†Ô∏è Extreme Tail Event</div>
                    <div class="comparison-insight-text">
                        <strong>No regime produced scenarios as severe as this historical crash.</strong> 
                        Even the Full Cycle data (which includes past crashes) fails to generate this severity level frequently.
                        This crash represents a true outlier in Bitcoin's history.
                    </div>
                </div>`;
            } else if (fullMax >= 15 && currentMax < 10) {
                // Full Cycle captures it best
                comparisonInsight = `<div class="comparison-insight" style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(251, 191, 36, 0.05) 100%); border-color: rgba(251, 191, 36, 0.4);">
                    <div class="comparison-insight-title" style="color: #fbbf24;">üîÑ Full Cycle Data Required</div>
                    <div class="comparison-insight-text">
                        The <strong>Full Cycle (2014-2025)</strong> at ${fullAvg.toFixed(0)}% best captures this crash severity.
                        Recent regime data alone (Current: ${currentAvg.toFixed(0)}%, Bear: ${bearAvg.toFixed(0)}%) underestimates.
                        <strong>Include full historical data for accurate tail risk modeling.</strong>
                    </div>
                </div>`;
            } else if (bearMax >= fullMax && bearMax >= currentMax && bearMax >= 15) {
                // Bear regime captures it best
                comparisonInsight = `<div class="comparison-insight" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(34, 197, 94, 0.05) 100%); border-color: rgba(34, 197, 94, 0.4);">
                    <div class="comparison-insight-title" style="color: #22c55e;">üêª Bear Regime Best Fit</div>
                    <div class="comparison-insight-text">
                        The <strong>Bear Regime (2018-2020)</strong> at ${bearAvg.toFixed(0)}% most accurately represents this crash.
                        For conservative stress testing, use bear market calibration.
                    </div>
                </div>`;
            } else {
                // Show summary
                comparisonInsight = `<div class="comparison-insight">
                    <div class="comparison-insight-title">üìä Regime Comparison</div>
                    <div class="comparison-insight-text">
                        Current: ${currentAvg.toFixed(0)}% | Bear: ${bearAvg.toFixed(0)}% | Full: ${fullAvg.toFixed(0)}%<br>
                        ${fullAvg > Math.max(currentAvg, bearAvg) ? 
                            '<strong>Full Cycle</strong> provides the most comprehensive stress estimate.' :
                            bearAvg > currentAvg ? 
                                '<strong>Bear Regime</strong> is most conservative.' : 
                                'Regimes show similar estimates.'}
                    </div>
                </div>`;
            }
            
            document.getElementById('percentile-context').innerHTML = `
                <div style="margin-bottom: 15px;">
                    At <strong>${result.startBCR.toFixed(1)}x BCR</strong>, the ${event.name} (-${result.maxDrawdown.toFixed(0)}% over ${Math.round((new Date(event.troughDate) - new Date(event.peakDate)) / (1000*60*60*24))} days) 
                    would have brought your position to <strong>${result.minBCR.toFixed(1)}x BCR</strong>.
                    ${result.survived ? 
                        '<span style="color: var(--accent-green); font-weight: 600;">‚úì Survived</span>' : 
                        '<span style="color: var(--accent-red); font-weight: 600;">‚úó Failed</span>'}
                </div>
                
                ${comparisonInsight}
            `;
            
            // Update Historical Rarity section using best fit regime
            updateHistoricalRarity(event, bestFitAvg);
        }
        
        // Unified histogram renderer
        function renderHistogram(containerId, data, historicalValue, modelColor, suffix, isDrawdown) {
            // Create histogram bins
            const maxVal = isDrawdown ? Math.max(...data) : Math.min(Math.max(...data), 100);
            const binSize = isDrawdown ? 5 : 2;
            const bins = [];
            const binCounts = [];
            
            for (let b = 0; b <= maxVal + binSize; b += binSize) {
                bins.push(b);
                const count = data.filter(v => v >= b && v < b + binSize).length;
                binCounts.push(count);
            }
            
            // For drawdowns, "worse" means higher; for BCR, "worse" means lower
            const isWorse = isDrawdown 
                ? (b => b > historicalValue) 
                : (b => b < historicalValue);
            
            const histTrace = {
                x: bins,
                y: binCounts,
                type: 'bar',
                marker: {
                    color: bins.map(b => isWorse(b) ? 'rgba(239, 68, 68, 0.6)' : modelColor + '60'),
                    line: { color: 'rgba(255,255,255,0.15)', width: 1 }
                },
                hovertemplate: `%{x}${suffix}: %{y} sims<extra></extra>`
            };
            
            const actualLine = {
                x: [historicalValue, historicalValue],
                y: [0, Math.max(...binCounts) * 1.15],
                type: 'scatter',
                mode: 'lines',
                line: { color: '#fbbf24', width: 2.5 },
                name: 'Historical'
            };
            
            const labelText = isDrawdown 
                ? `-${historicalValue.toFixed(0)}%` 
                : `${historicalValue.toFixed(1)}x`;
            
            Plotly.newPlot(containerId, [histTrace, actualLine], {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { family: 'Space Grotesk', color: '#a0a0b0', size: 9 },
                margin: { t: 5, r: 10, b: 25, l: 30 },
                xaxis: {
                    gridcolor: '#2a2a3a',
                    ticksuffix: suffix,
                    tickfont: { size: 8 }
                },
                yaxis: {
                    gridcolor: '#2a2a3a',
                    showticklabels: false
                },
                showlegend: false,
                bargap: 0.08,
                annotations: [{
                    x: historicalValue,
                    y: Math.max(...binCounts) * 0.9,
                    text: labelText,
                    showarrow: false,
                    font: { color: '#fbbf24', size: 9, weight: 'bold' },
                    bgcolor: 'rgba(251, 191, 36, 0.15)',
                    borderpad: 2
                }]
            }, { responsive: true, displayModeBar: false });
        }
        
        // Initialize stress test controls on page load
        document.addEventListener('DOMContentLoaded', initStressTestControls);
        
        // Override selectDrawdown to also run stress test
        const originalSelectDrawdown = selectDrawdown;
        selectDrawdown = function(year) {
            originalSelectDrawdown(year);
            // Run stress test after a short delay to let UI update
            setTimeout(() => {
                if (selectedEvent) {
                    runStressTest(selectedEvent);
                }
            }, 100);
        };
    </script>
</body>
</html>
