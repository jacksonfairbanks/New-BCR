<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC Drawdowns & Path Dependency | Underwriting Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="../js/btc-data.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --border-color: #2a2a3a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --text-muted: #606070;
            --accent-orange: #f7931a;
            --accent-red: #ff4757;
            --accent-green: #00d4aa;
            --accent-blue: #4a9eff;
            --accent-purple: #a855f7;
            --accent-yellow: #ffd700;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .bg-pattern {
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(ellipse at 20% 30%, rgba(255, 71, 87, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 70%, rgba(168, 85, 247, 0.05) 0%, transparent 40%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            position: relative;
            z-index: 1;
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
        }
        
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, rgba(255, 71, 87, 0.3), rgba(255, 71, 87, 0.1));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 1px solid rgba(255, 71, 87, 0.3);
        }
        
        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .subtitle {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        
        .home-btn {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .home-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-orange);
            color: var(--accent-orange);
        }
        
        /* Main chart card */
        .main-chart-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .chart-hint {
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        
        .chart-hint span {
            color: var(--accent-red);
        }
        
        #main-chart {
            height: 450px;
            width: 100%;
        }
        
        /* Drawdown selector cards */
        .drawdown-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .dd-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
        }
        
        .dd-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--card-color);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .dd-card:hover {
            transform: translateY(-4px);
            border-color: var(--card-color);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3), 0 0 30px color-mix(in srgb, var(--card-color) 20%, transparent);
        }
        
        .dd-card:hover::before, .dd-card.active::before {
            opacity: 1;
        }
        
        .dd-card.active {
            border-color: var(--card-color);
            background: color-mix(in srgb, var(--card-color) 5%, var(--bg-secondary));
        }
        
        .dd-card.dd-2014 { --card-color: #ff4757; }
        .dd-card.dd-2018 { --card-color: #a855f7; }
        .dd-card.dd-2022 { --card-color: #4a9eff; }
        
        .dd-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .dd-year {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--card-color);
        }
        
        .dd-severity {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: color-mix(in srgb, var(--card-color) 15%, transparent);
            color: var(--card-color);
            border: 1px solid color-mix(in srgb, var(--card-color) 30%, transparent);
        }
        
        .dd-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .dd-quick-stats {
            display: flex;
            gap: 20px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }
        
        .dd-stat {
            flex: 1;
        }
        
        .dd-stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
        }
        
        .dd-stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .dd-stat-value.red { color: var(--accent-red); }
        .dd-stat-value.orange { color: var(--accent-orange); }
        
        /* Detail panel */
        .detail-panel {
            display: none;
            animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .detail-panel.active {
            display: block;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .detail-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
        }
        
        .detail-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .detail-title h2 {
            font-size: 1.6rem;
            font-weight: 700;
        }
        
        .detail-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            background: rgba(255, 71, 87, 0.15);
            color: var(--accent-red);
            border: 1px solid rgba(255, 71, 87, 0.3);
        }
        
        .close-detail {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .close-detail:hover {
            background: var(--accent-red);
            border-color: var(--accent-red);
            color: white;
        }
        
        /* Stats grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 18px;
        }
        
        .stat-card.highlight {
            background: linear-gradient(135deg, rgba(255, 71, 87, 0.1), rgba(255, 71, 87, 0.02));
            border-color: rgba(255, 71, 87, 0.3);
        }
        
        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .stat-value.red { color: var(--accent-red); }
        .stat-value.green { color: var(--accent-green); }
        .stat-value.orange { color: var(--accent-orange); }
        .stat-value.blue { color: var(--accent-blue); }
        .stat-value.purple { color: var(--accent-purple); }
        
        /* Detail grid */
        .detail-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
        }
        
        .chart-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
        }
        
        .chart-card-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-card-title .icon {
            font-size: 1.1rem;
        }
        
        #zoom-chart {
            height: 350px;
        }
        
        /* Narrative section */
        .narrative-section {
            margin-bottom: 20px;
        }
        
        .narrative-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--accent-orange);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .narrative-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.7;
        }
        
        .narrative-text strong {
            color: var(--text-primary);
        }
        
        /* Timeline */
        .timeline {
            position: relative;
            padding-left: 25px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 5px;
            bottom: 5px;
            width: 2px;
            background: var(--border-color);
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -21px;
            top: 6px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-red);
            border: 2px solid var(--bg-secondary);
        }
        
        .timeline-item.recovery::before {
            background: var(--accent-green);
        }
        
        .timeline-date {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 4px;
        }
        
        .timeline-event {
            font-size: 0.9rem;
            color: var(--text-primary);
        }
        
        /* Clustering stats */
        .clustering-section {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 18px;
            margin-top: 20px;
        }
        
        .clustering-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--accent-purple);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .clustering-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .clustering-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            position: relative;
        }
        
        .clustering-label {
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .clustering-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }
        
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            color: var(--text-muted);
            font-size: 10px;
            font-weight: 600;
            cursor: help;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .info-icon:hover {
            background: var(--accent-orange);
            color: var(--bg-primary);
        }
        
        .metric-tooltip {
            position: absolute;
            left: 0;
            bottom: calc(100% + 8px);
            width: 280px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(5px);
            transition: all 0.2s ease;
            pointer-events: none;
        }
        
        .info-icon:hover + .metric-tooltip,
        .metric-tooltip:hover {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            pointer-events: auto;
        }
        
        .metric-tooltip::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 20px;
            width: 10px;
            height: 10px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            transform: rotate(45deg);
        }
        
        .tooltip-title {
            font-weight: 600;
            color: var(--accent-orange);
            margin-bottom: 6px;
            font-size: 0.85rem;
        }
        
        .tooltip-desc {
            color: var(--text-secondary);
            font-size: 0.8rem;
            line-height: 1.5;
            margin-bottom: 8px;
        }
        
        .tooltip-why {
            font-size: 0.75rem;
            color: var(--text-muted);
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
            font-style: italic;
        }
        
        .tooltip-why strong {
            color: var(--accent-green);
            font-style: normal;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
            .detail-grid { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 768px) {
            .drawdown-selector { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">üìâ</div>
                <div>
                    <h1>Drawdowns & Path Dependency</h1>
                    <p class="subtitle">Interactive analysis of Bitcoin's most severe declines</p>
                </div>
            </div>
            <a href="../index.html" class="home-btn">‚Üê Dashboard</a>
        </header>

        <!-- Main BTC Chart -->
        <div class="main-chart-card">
            <div class="chart-header">
                <div class="chart-title">Bitcoin Price History (2014‚Äì2025)</div>
                <div class="chart-hint">Click on <span>highlighted regions</span> to explore each drawdown</div>
            </div>
            <div id="main-chart"></div>
        </div>

        <!-- Drawdown Selector Cards -->
        <div class="drawdown-selector">
            <div class="dd-card dd-2014" onclick="selectDrawdown('2014')">
                <div class="dd-card-header">
                    <div class="dd-year">2014</div>
                    <div class="dd-severity">Catastrophic</div>
                </div>
                <div class="dd-name">Mt. Gox Collapse</div>
                <div class="dd-quick-stats">
                    <div class="dd-stat">
                        <div class="dd-stat-label">Max Drawdown</div>
                        <div class="dd-stat-value red">-86%</div>
                    </div>
                    <div class="dd-stat">
                        <div class="dd-stat-label">Duration</div>
                        <div class="dd-stat-value orange">411 days</div>
                    </div>
                </div>
            </div>

            <div class="dd-card dd-2018" onclick="selectDrawdown('2018')">
                <div class="dd-card-header">
                    <div class="dd-year">2018</div>
                    <div class="dd-severity">Catastrophic</div>
                </div>
                <div class="dd-name">ICO Bubble Burst</div>
                <div class="dd-quick-stats">
                    <div class="dd-stat">
                        <div class="dd-stat-label">Max Drawdown</div>
                        <div class="dd-stat-value red">-84%</div>
                    </div>
                    <div class="dd-stat">
                        <div class="dd-stat-label">Duration</div>
                        <div class="dd-stat-value orange">364 days</div>
                    </div>
                </div>
            </div>

            <div class="dd-card dd-2022" onclick="selectDrawdown('2022')">
                <div class="dd-card-header">
                    <div class="dd-year">2022</div>
                    <div class="dd-severity">Severe</div>
                </div>
                <div class="dd-name">Fed Tightening & Contagion</div>
                <div class="dd-quick-stats">
                    <div class="dd-stat">
                        <div class="dd-stat-label">Max Drawdown</div>
                        <div class="dd-stat-value red">-77%</div>
                    </div>
                    <div class="dd-stat">
                        <div class="dd-stat-label">Duration</div>
                        <div class="dd-stat-value orange">394 days</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detail Panel (hidden by default) -->
        <div class="detail-panel" id="detail-panel">
            <div class="detail-header">
                <div class="detail-title">
                    <h2 id="detail-title">2014 Mt. Gox Collapse</h2>
                    <div class="detail-badge" id="detail-badge">-86% Peak to Trough</div>
                </div>
                <button class="close-detail" onclick="closeDetail()">‚úï Close Analysis</button>
            </div>

            <!-- Stats Row -->
            <div class="stats-grid" id="stats-grid">
                <div class="stat-card highlight">
                    <div class="stat-label">Maximum Drawdown</div>
                    <div class="stat-value red" id="stat-dd">-86.0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Peak Price</div>
                    <div class="stat-value green" id="stat-peak">$1,163</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Trough Price</div>
                    <div class="stat-value red" id="stat-trough">$162</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Duration (Days)</div>
                    <div class="stat-value orange" id="stat-duration">411</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Recovery Time</div>
                    <div class="stat-value blue" id="stat-recovery">1,186 days</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Daily Vol</div>
                    <div class="stat-value purple" id="stat-vol">4.8%</div>
                </div>
            </div>

            <!-- Detail Grid -->
            <div class="detail-grid">
                <div class="chart-card">
                    <div class="chart-card-title">
                        <span class="icon">üîç</span>
                        Zoomed Price Action
                    </div>
                    <div id="zoom-chart"></div>
                </div>

                <div class="chart-card">
                    <div class="narrative-section">
                        <div class="narrative-title">
                            <span>‚ö°</span> Catalyst Analysis
                        </div>
                        <div class="narrative-text" id="catalyst-text">
                            Loading...
                        </div>
                    </div>

                    <div class="narrative-section">
                        <div class="narrative-title">
                            <span>üìÖ</span> Event Timeline
                        </div>
                        <div class="timeline" id="event-timeline">
                            <!-- Timeline items populated by JS -->
                        </div>
                    </div>

                    <div class="clustering-section">
                        <div class="clustering-title">üìä Behavioral Patterns</div>
                        <div class="clustering-grid" id="clustering-stats">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // Drawdowns & Path Dependency Analysis
        // ========================================
        
        // Major drawdown event data
        const DRAWDOWN_EVENTS = {
            '2014': {
                name: 'Mt. Gox Collapse',
                peakDate: '2013-11-29',
                troughDate: '2015-01-14',
                peakPrice: 1163,
                troughPrice: 162,
                maxDrawdown: -86.0,
                durationDays: 411,
                recoveryDays: 1186,
                avgDailyVol: 4.8,
                catalyst: `The 2014 crash was triggered by the <strong>collapse of Mt. Gox</strong>, then handling ~70% of all Bitcoin transactions. In February 2014, the exchange halted withdrawals citing a "transaction malleability" bug, later revealing 850,000 BTC had been stolen over several years. This was compounded by regulatory uncertainty as China banned financial institutions from handling Bitcoin.`,
                timeline: [
                    { date: 'Nov 29, 2013', event: 'BTC peaks at $1,163 amid China speculation', type: 'peak' },
                    { date: 'Dec 5, 2013', event: 'PBoC bans financial institutions from BTC', type: 'crisis' },
                    { date: 'Feb 7, 2014', event: 'Mt. Gox halts all withdrawals', type: 'crisis' },
                    { date: 'Feb 24, 2014', event: 'Mt. Gox goes offline, files bankruptcy', type: 'crisis' },
                    { date: 'Jan 14, 2015', event: 'BTC bottoms at $162', type: 'trough' },
                    { date: 'Dec 2017', event: 'Price finally recovers to ATH', type: 'recovery' }
                ],
                clustering: {
                    'Consecutive -10% Days': '7 events',
                    'Largest Single Day Drop': '-23.4%',
                    'Days Below -50% DD': '294',
                    'Bounce Attempts (>20%)': '4',
                    'Capitulation Volume Spike': '8.2x avg',
                    'Correlation w/ S&P': '0.12'
                },
                chartRange: ['2013-10-01', '2016-01-01']
            },
            '2018': {
                name: 'ICO Bubble Burst',
                peakDate: '2017-12-17',
                troughDate: '2018-12-15',
                peakPrice: 19783,
                troughPrice: 3191,
                maxDrawdown: -83.8,
                durationDays: 364,
                recoveryDays: 1089,
                avgDailyVol: 4.2,
                catalyst: `The 2018 crash followed the <strong>ICO mania of 2017</strong> where thousands of speculative tokens raised billions. The bubble burst when the SEC began cracking down on unregistered securities offerings. The crash was accelerated by the Bitcoin Cash hash war in November 2018, and mass liquidations on newly-launched leveraged products.`,
                timeline: [
                    { date: 'Dec 17, 2017', event: 'BTC peaks at $19,783 during ICO mania', type: 'peak' },
                    { date: 'Jan 2018', event: 'South Korea announces crypto regulations', type: 'crisis' },
                    { date: 'Mar 2018', event: 'Google, Facebook ban crypto ads', type: 'crisis' },
                    { date: 'Nov 15, 2018', event: 'Bitcoin Cash hash war triggers panic', type: 'crisis' },
                    { date: 'Dec 15, 2018', event: 'BTC bottoms at $3,191', type: 'trough' },
                    { date: 'Nov 2020', event: 'Price finally recovers to ATH', type: 'recovery' }
                ],
                clustering: {
                    'Consecutive -10% Days': '5 events',
                    'Largest Single Day Drop': '-16.8%',
                    'Days Below -50% DD': '206',
                    'Bounce Attempts (>20%)': '6',
                    'Capitulation Volume Spike': '5.4x avg',
                    'Correlation w/ S&P': '0.28'
                },
                chartRange: ['2017-10-01', '2020-01-01']
            },
            '2022': {
                name: 'Fed Tightening & Contagion',
                peakDate: '2021-11-10',
                troughDate: '2022-11-21',
                peakPrice: 68789,
                troughPrice: 15476,
                maxDrawdown: -77.5,
                durationDays: 394,
                recoveryDays: 766,
                avgDailyVol: 3.6,
                catalyst: `The 2022 crash was driven by <strong>aggressive Fed rate hikes</strong> to combat inflation, causing a broad risk-off environment. The crypto-specific damage came from cascading failures: the <strong>$60B Terra/Luna collapse</strong> in May, Three Arrows Capital's bankruptcy in June, and the <strong>FTX fraud revelation</strong> in November, which destroyed confidence in centralized exchanges.`,
                timeline: [
                    { date: 'Nov 10, 2021', event: 'BTC peaks at $68,789', type: 'peak' },
                    { date: 'May 9, 2022', event: 'Terra/Luna depegs, triggers cascade', type: 'crisis' },
                    { date: 'Jun 13, 2022', event: 'Celsius halts withdrawals', type: 'crisis' },
                    { date: 'Jun 27, 2022', event: 'Three Arrows Capital files bankruptcy', type: 'crisis' },
                    { date: 'Nov 8, 2022', event: 'FTX halts withdrawals, fraud exposed', type: 'crisis' },
                    { date: 'Nov 21, 2022', event: 'BTC bottoms at $15,476', type: 'trough' },
                    { date: 'Mar 2024', event: 'Price recovers to ATH', type: 'recovery' }
                ],
                clustering: {
                    'Consecutive -10% Days': '3 events',
                    'Largest Single Day Drop': '-14.2%',
                    'Days Below -50% DD': '187',
                    'Bounce Attempts (>20%)': '3',
                    'Capitulation Volume Spike': '4.1x avg',
                    'Correlation w/ S&P': '0.67'
                },
                chartRange: ['2021-09-01', '2024-01-01']
            }
        };

        let selectedEvent = null;

        // Metric explanations for tooltips
        const METRIC_EXPLANATIONS = {
            'Consecutive -10% Days': {
                title: 'Consecutive -10% Days',
                desc: 'Number of times the price fell 10% or more on consecutive trading days during the drawdown period.',
                why: '<strong>Why it matters:</strong> Clustering of extreme losses indicates panic selling and forced liquidations‚Äîkey stress signals for leveraged treasury positions.'
            },
            'Largest Single Day Drop': {
                title: 'Largest Single Day Drop',
                desc: 'The worst single-day percentage decline during the entire drawdown event.',
                why: '<strong>Why it matters:</strong> Flash crashes can trigger margin calls and forced selling, especially for treasuries using BTC as collateral.'
            },
            'Days Below -50% DD': {
                title: 'Days Below -50% Drawdown',
                desc: 'Total number of days where price remained more than 50% below the previous all-time high.',
                why: '<strong>Why it matters:</strong> Extended periods of deep drawdown test the solvency and psychological resolve of long-term holders and institutional treasuries.'
            },
            'Bounce Attempts (>20%)': {
                title: 'Bounce Attempts (>20%)',
                desc: 'Number of rallies exceeding 20% that occurred during the drawdown before the ultimate bottom.',
                why: '<strong>Why it matters:</strong> "Bear market rallies" can trap investors and indicate ongoing volatility‚Äîuseful for modeling path dependency risk.'
            },
            'Capitulation Volume Spike': {
                title: 'Capitulation Volume Spike',
                desc: 'Peak trading volume during the drawdown expressed as a multiple of average daily volume.',
                why: '<strong>Why it matters:</strong> Volume spikes often mark capitulation events where weak hands exit, potentially signaling a bottom or acceleration of selling.'
            },
            'Correlation w/ S&P': {
                title: 'Correlation with S&P 500',
                desc: 'Rolling 30-day correlation between BTC returns and S&P 500 returns during the drawdown period.',
                why: '<strong>Why it matters:</strong> Higher correlation means BTC offers less diversification during market stress‚Äîcritical for portfolio risk assessment.'
            }
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[Drawdowns] Initializing...');
            console.log('[Drawdowns] BTC_PRICES available:', typeof window.BTC_PRICES !== 'undefined');
            console.log('[Drawdowns] Data length:', window.BTC_PRICES ? window.BTC_PRICES.length : 0);
            
            if (window.BTC_PRICES && window.BTC_PRICES.length > 100) {
                console.log('[Drawdowns] Data range:', window.BTC_PRICES[0].date, 'to', window.BTC_PRICES[window.BTC_PRICES.length-1].date);
                renderMainChart();
            } else {
                console.error('[Drawdowns] BTC data not loaded');
                document.getElementById('main-chart').innerHTML = 
                    '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--accent-red);">' +
                    '<span>Failed to load BTC data. Check console for errors.</span></div>';
            }
        });

        function renderMainChart() {
            // Get full BTC data from 2014
            const data = window.BTC_PRICES.filter(d => {
                const year = new Date(d.date).getFullYear();
                return year >= 2014;
            });

            // Main price trace
            const priceTrace = {
                x: data.map(d => d.date),
                y: data.map(d => d.price),
                type: 'scatter',
                mode: 'lines',
                name: 'BTC Price',
                line: { color: '#f7931a', width: 2 },
                hovertemplate: '%{x}<br>$%{y:,.0f}<extra></extra>'
            };

            // Highlight zones for each drawdown
            const shapes = [
                // 2014 drawdown
                {
                    type: 'rect',
                    xref: 'x', yref: 'paper',
                    x0: '2013-11-29', x1: '2015-01-14',
                    y0: 0, y1: 1,
                    fillcolor: 'rgba(255, 71, 87, 0.15)',
                    line: { width: 0 }
                },
                // 2018 drawdown  
                {
                    type: 'rect',
                    xref: 'x', yref: 'paper',
                    x0: '2017-12-17', x1: '2018-12-15',
                    y0: 0, y1: 1,
                    fillcolor: 'rgba(168, 85, 247, 0.15)',
                    line: { width: 0 }
                },
                // 2022 drawdown
                {
                    type: 'rect',
                    xref: 'x', yref: 'paper',
                    x0: '2021-11-10', x1: '2022-11-21',
                    y0: 0, y1: 1,
                    fillcolor: 'rgba(74, 158, 255, 0.15)',
                    line: { width: 0 }
                }
            ];

            // Annotations for peaks
            const annotations = [
                { x: '2013-11-29', y: 1163, text: '2014', showarrow: true, arrowhead: 0, ax: 0, ay: -40, font: { color: '#ff4757', size: 14, family: 'JetBrains Mono' } },
                { x: '2017-12-17', y: 19783, text: '2018', showarrow: true, arrowhead: 0, ax: 0, ay: -40, font: { color: '#a855f7', size: 14, family: 'JetBrains Mono' } },
                { x: '2021-11-10', y: 68789, text: '2022', showarrow: true, arrowhead: 0, ax: 0, ay: -40, font: { color: '#4a9eff', size: 14, family: 'JetBrains Mono' } }
            ];

            Plotly.newPlot('main-chart', [priceTrace], {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { family: 'Space Grotesk', color: '#a0a0b0' },
                margin: { t: 30, r: 50, b: 50, l: 80 },
                xaxis: {
                    gridcolor: '#2a2a3a',
                    showgrid: true,
                    tickfont: { size: 11 }
                },
                yaxis: {
                    gridcolor: '#2a2a3a',
                    type: 'log',
                    tickprefix: '$',
                    tickfont: { size: 11 },
                    showgrid: true
                },
                shapes: shapes,
                annotations: annotations,
                hovermode: 'x unified',
                showlegend: false
            }, { 
                responsive: true,
                displayModeBar: false
            });

            // Add click handler
            document.getElementById('main-chart').on('plotly_click', function(data) {
                const clickDate = new Date(data.points[0].x);
                
                // Determine which drawdown region was clicked
                if (clickDate >= new Date('2013-11-01') && clickDate <= new Date('2015-02-01')) {
                    selectDrawdown('2014');
                } else if (clickDate >= new Date('2017-12-01') && clickDate <= new Date('2019-01-01')) {
                    selectDrawdown('2018');
                } else if (clickDate >= new Date('2021-11-01') && clickDate <= new Date('2023-01-01')) {
                    selectDrawdown('2022');
                }
            });
        }

        function selectDrawdown(year) {
            selectedEvent = DRAWDOWN_EVENTS[year];
            
            // Update card active state
            document.querySelectorAll('.dd-card').forEach(card => card.classList.remove('active'));
            document.querySelector(`.dd-${year}`).classList.add('active');
            
            // Show and populate detail panel
            document.getElementById('detail-panel').classList.add('active');
            
            // Update header
            document.getElementById('detail-title').textContent = `${year} ${selectedEvent.name}`;
            document.getElementById('detail-badge').textContent = `${selectedEvent.maxDrawdown.toFixed(1)}% Peak to Trough`;
            
            // Update stats
            document.getElementById('stat-dd').textContent = `${selectedEvent.maxDrawdown.toFixed(1)}%`;
            document.getElementById('stat-peak').textContent = `$${selectedEvent.peakPrice.toLocaleString()}`;
            document.getElementById('stat-trough').textContent = `$${selectedEvent.troughPrice.toLocaleString()}`;
            document.getElementById('stat-duration').textContent = selectedEvent.durationDays;
            document.getElementById('stat-recovery').textContent = `${selectedEvent.recoveryDays.toLocaleString()} days`;
            document.getElementById('stat-vol').textContent = `${selectedEvent.avgDailyVol}%`;
            
            // Update catalyst text
            document.getElementById('catalyst-text').innerHTML = selectedEvent.catalyst;
            
            // Update timeline
            const timelineHtml = selectedEvent.timeline.map(item => `
                <div class="timeline-item ${item.type === 'recovery' ? 'recovery' : ''}">
                    <div class="timeline-date">${item.date}</div>
                    <div class="timeline-event">${item.event}</div>
                </div>
            `).join('');
            document.getElementById('event-timeline').innerHTML = timelineHtml;
            
            // Update clustering stats with info tooltips
            const clusteringHtml = Object.entries(selectedEvent.clustering).map(([key, value]) => {
                const explanation = METRIC_EXPLANATIONS[key] || { title: key, desc: '', why: '' };
                return `
                <div class="clustering-item">
                    <span class="clustering-label">
                        ${key}
                        <span class="info-icon">?</span>
                        <div class="metric-tooltip">
                            <div class="tooltip-title">${explanation.title}</div>
                            <div class="tooltip-desc">${explanation.desc}</div>
                            <div class="tooltip-why">${explanation.why}</div>
                        </div>
                    </span>
                    <span class="clustering-value">${value}</span>
                </div>
            `}).join('');
            document.getElementById('clustering-stats').innerHTML = clusteringHtml;
            
            // Render zoomed chart
            renderZoomChart(selectedEvent);
            
            // Scroll to detail panel
            document.getElementById('detail-panel').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function renderZoomChart(event) {
            const [startDate, endDate] = event.chartRange;
            
            const data = window.BTC_PRICES.filter(d => {
                return d.date >= startDate && d.date <= endDate;
            });
            
            // Calculate drawdown from ATH within this window
            let ath = 0;
            const ddData = data.map(d => {
                if (d.price > ath) ath = d.price;
                return { date: d.date, price: d.price, dd: ((d.price - ath) / ath) * 100 };
            });

            // Price trace
            const priceTrace = {
                x: data.map(d => d.date),
                y: data.map(d => d.price),
                type: 'scatter',
                mode: 'lines',
                name: 'Price',
                line: { color: '#f7931a', width: 2 },
                yaxis: 'y',
                hovertemplate: '$%{y:,.0f}<extra>Price</extra>'
            };

            // Drawdown trace
            const ddTrace = {
                x: ddData.map(d => d.date),
                y: ddData.map(d => d.dd),
                type: 'scatter',
                mode: 'lines',
                name: 'Drawdown',
                fill: 'tozeroy',
                fillcolor: 'rgba(255, 71, 87, 0.2)',
                line: { color: '#ff4757', width: 1 },
                yaxis: 'y2',
                hovertemplate: '%{y:.1f}%<extra>Drawdown</extra>'
            };

            Plotly.newPlot('zoom-chart', [priceTrace, ddTrace], {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { family: 'Space Grotesk', color: '#a0a0b0' },
                margin: { t: 20, r: 60, b: 40, l: 70 },
                xaxis: {
                    gridcolor: '#2a2a3a',
                    tickfont: { size: 10 }
                },
                yaxis: {
                    gridcolor: '#2a2a3a',
                    type: 'log',
                    tickprefix: '$',
                    tickfont: { size: 10 },
                    side: 'left'
                },
                yaxis2: {
                    overlaying: 'y',
                    side: 'right',
                    ticksuffix: '%',
                    tickfont: { size: 10, color: '#ff4757' },
                    showgrid: false,
                    range: [-100, 10],
                    zeroline: false
                },
                legend: { x: 0.02, y: 0.98, bgcolor: 'rgba(0,0,0,0.5)', font: { size: 10 } },
                hovermode: 'x unified',
                shapes: [
                    // Peak marker
                    { type: 'line', x0: event.peakDate, x1: event.peakDate, y0: 0, y1: 1, yref: 'paper', line: { color: '#00d4aa', width: 1, dash: 'dot' } },
                    // Trough marker
                    { type: 'line', x0: event.troughDate, x1: event.troughDate, y0: 0, y1: 1, yref: 'paper', line: { color: '#ff4757', width: 1, dash: 'dot' } }
                ]
            }, { 
                responsive: true,
                displayModeBar: false 
            });
        }

        function closeDetail() {
            document.getElementById('detail-panel').classList.remove('active');
            document.querySelectorAll('.dd-card').forEach(card => card.classList.remove('active'));
            selectedEvent = null;
            
            // Scroll back to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>
